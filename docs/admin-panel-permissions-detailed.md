# Workmateç®¡ç†ç”»é¢ æ¨©é™åˆ¥ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡è©³ç´°ã‚¬ã‚¤ãƒ‰

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€Workmateç®¡ç†ç”»é¢ã®å„æ©Ÿèƒ½ã«ãŠã„ã¦ã€ã©ã®æ¨©é™ãƒ¬ãƒ™ãƒ«ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã©ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã‚’è©³ç´°ã«èª¬æ˜ã—ã¾ã™ã€‚

## ğŸ” **çµ±ä¸€ã•ã‚ŒãŸæ¨©é™éšå±¤**

### **æ­£ã—ã„æ¨©é™éšå±¤ï¼ˆä¿®æ­£å¾Œï¼‰**
```
ç‰¹åˆ¥ç®¡ç†è€… (queue@queueu-tech.jp) â†’ ğŸŒ å…¨ç¤¾ã®ãƒ‡ãƒ¼ã‚¿
adminï¼ˆã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ï¼‰ â†’ ğŸ¢ è‡ªç¤¾ãƒ‡ãƒ¼ã‚¿ã®ã¿ â€»admin_userã¨åŒç­‰  
admin_userï¼ˆä¼šç¤¾ç¤¾é•·ï¼‰ â†’ ğŸ¢ è‡ªç¤¾ãƒ‡ãƒ¼ã‚¿ã®ã¿ â€»adminã¨åŒç­‰
userï¼ˆä¼šç¤¾ç®¡ç†è€…ï¼‰ â†’ ğŸ¢ è‡ªç¤¾ãƒ‡ãƒ¼ã‚¿ã®ã¿  
employeeï¼ˆç¤¾å“¡ï¼‰ â†’ âŒ ç®¡ç†ç”»é¢ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
```

### **adminã¨admin_userã®é•ã„**
- **åŸºæœ¬çš„ã«åŒç­‰ã®æ¨©é™**ï¼ˆè‡ªç¤¾ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰
- **é•ã„ã¯ä»¥ä¸‹ã®ã¿ï¼š**
  - **ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¶ˆå»æ¨©é™**ï¼šadminã®æ–¹ãŒå‰Šé™¤æ¨©é™ãŒå¼·ã„
  - **ä½œæˆã§ãã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç¨®é¡**ï¼šadminã¯ä»–ã®adminã‚’ä½œæˆå¯èƒ½

## ğŸ“Š **æ©Ÿèƒ½åˆ¥æ¨©é™ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ï¼ˆä¿®æ­£å¾Œï¼‰**

| æ©Ÿèƒ½ | ç‰¹åˆ¥ç®¡ç†è€… | admin | admin_user | user | employee |
|------|-----------|-------|------------|------|----------|
| **ç¤¾å“¡ç®¡ç†** | ğŸŒ å…¨ç¤¾å“¡ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | âŒ |
| **ãƒãƒ£ãƒƒãƒˆå±¥æ­´** | ğŸŒ å…¨ãƒ‡ãƒ¼ã‚¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | âŒ |
| **CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰** | ğŸŒ å…¨ãƒ‡ãƒ¼ã‚¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | âŒ |
| **ãƒãƒ£ãƒƒãƒˆåˆ†æ** | ğŸŒ å…¨ãƒ‡ãƒ¼ã‚¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | âŒ |
| **è©³ç´°åˆ†æ** | ğŸŒ å…¨ãƒ‡ãƒ¼ã‚¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | âŒ |
| **ãƒ—ãƒ©ãƒ³å±¥æ­´** | ğŸŒ å…¨ãƒ‡ãƒ¼ã‚¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | âŒ | âŒ |
| **ç¤¾å“¡åˆ©ç”¨çŠ¶æ³** | ğŸŒ å…¨ãƒ‡ãƒ¼ã‚¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | âŒ |
| **ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†** | ğŸŒ å…¨ãƒ‡ãƒ¼ã‚¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | âŒ |
| **å¼·åŒ–åˆ†æ** | ğŸŒ å…¨ãƒ‡ãƒ¼ã‚¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | âŒ |

## 1. æ¨©é™ãƒ¬ãƒ™ãƒ«å®šç¾©

### 1.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã®éšå±¤

| æ¨©é™ãƒ¬ãƒ™ãƒ« | ãƒ­ãƒ¼ãƒ«å | ã‚¢ã‚¯ã‚»ã‚¹ç¯„å›² | èª¬æ˜ |
|-----------|---------|-------------|------|
| **ç‰¹åˆ¥ç®¡ç†è€…** | `queue@queueu-tech.jp` | å…¨ãƒ‡ãƒ¼ã‚¿ | ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ç®¡ç†è€…ã€å…¨ç¤¾ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ |
| **ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…** | `admin` | è‡ªç¤¾ãƒ‡ãƒ¼ã‚¿ã®ã¿ | admin_userã¨åŒç­‰ã€å‰Šé™¤ãƒ»ä½œæˆæ¨©é™ã®ã¿é•ã„ |
| **ä¼šç¤¾ç¤¾é•·** | `admin_user` | è‡ªç¤¾ãƒ‡ãƒ¼ã‚¿ã®ã¿ | adminã¨åŒç­‰ã€å‰Šé™¤ãƒ»ä½œæˆæ¨©é™ã®ã¿é•ã„ |
| **ä¼šç¤¾ç®¡ç†è€…** | `user` | è‡ªç¤¾ãƒ‡ãƒ¼ã‚¿ã®ã¿ | è‡ªåˆ†ã®ä¼šç¤¾ã«æ‰€å±ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ |
| **ç¤¾å“¡** | `employee` | **ç®¡ç†ç”»é¢ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯** | ç®¡ç†ç”»é¢ã¸ã®å®Œå…¨ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ |

### 1.2 æ¨©é™åˆ¤å®šã‚³ãƒ¼ãƒ‰ï¼ˆauth.pyï¼‰

```python
def get_admin_or_user(user = Depends(get_current_user)):
    # ç‰¹åˆ¥ç®¡ç†è€…ã®åˆ¤å®š
    if user["email"] == "queue@queueu-tech.jp":
        user["is_special_admin"] = True
    
    # ç¤¾å“¡ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯å®Œå…¨ã«ãƒ–ãƒ­ãƒƒã‚¯
    if user["role"] == "employee":
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="ç¤¾å“¡ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ç®¡ç†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“",
        )
```

## 2. ãƒãƒ£ãƒƒãƒˆå±¥æ­´æ©Ÿèƒ½ã®æ¨©é™åˆ¶å¾¡

### 2.1 API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /chatbot/api/admin/chat-history`
- **æ¨©é™ãƒã‚§ãƒƒã‚¯**: `get_admin_or_user`

### 2.2 æ¨©é™åˆ¥è¡¨ç¤ºãƒ‡ãƒ¼ã‚¿

| æ¨©é™ãƒ¬ãƒ™ãƒ« | è¡¨ç¤ºã•ã‚Œã‚‹ãƒãƒ£ãƒƒãƒˆå±¥æ­´ | ä¼šç¤¾IDåˆ¶é™ | å®Ÿè£…å ´æ‰€ |
|-----------|------------------|----------|----------|
| **ç‰¹åˆ¥ç®¡ç†è€…** (`queue@queueu-tech.jp`) | **å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´** | âŒ ãªã— | `get_chat_history(None, db)` |
| **ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…** (`admin`) | **è‡ªç¤¾ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ã¿** | âœ… ã‚ã‚Š | `get_chat_history_by_company(company_id, db)` |
| **ä¼šç¤¾ç¤¾é•·** (`admin_user`) | **è‡ªç¤¾ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ã¿** | âœ… ã‚ã‚Š | `get_chat_history_by_company(company_id, db)` |
| **ä¼šç¤¾ç®¡ç†è€…** (`user`) | **è‡ªç¤¾ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ã¿** | âœ… ã‚ã‚Š | `get_chat_history_by_company(company_id, db)` |

### 2.3 ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ•ãƒ­ãƒ¼

```python
# main.py ã® admin_get_chat_history é–¢æ•°
if is_special_admin:
    chat_history, total_count = get_chat_history_paginated(None, db, limit, offset)
elif is_admin:
    chat_history, total_count = get_chat_history_paginated(None, db, limit, offset)  
elif is_company_manager:  # user ã¾ãŸã¯ admin_user
    company_id = current_user.get("company_id")
    if company_id:
        chat_history, total_count = get_chat_history_by_company_paginated(company_id, db, limit, offset)
```

### 2.4 ä¼šç¤¾IDåˆ¶é™ã®å®Ÿè£…ï¼ˆadmin.pyï¼‰

```python
def get_chat_history_by_company_paginated(company_id: str, db = None, limit: int = 30, offset: int = 0):
    # 1. ä¼šç¤¾ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDä¸€è¦§ã‚’å–å¾—
    users_result = select_data("users", columns="id", filters={"company_id": company_id})
    user_ids = [user["id"] for user in users_result.data]
    
    # 2. å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å–å¾—
    for user_id in user_ids:
        user_result = select_data("chat_history", filters={"employee_id": user_id})
```

## 3. ç¤¾å“¡ç®¡ç†æ©Ÿèƒ½ã®æ¨©é™åˆ¶å¾¡

### 3.1 API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /chatbot/api/admin/company-employees`
- **æ¨©é™ãƒã‚§ãƒƒã‚¯**: `get_admin_or_user`

### 3.2 æ¨©é™åˆ¥è¡¨ç¤ºãƒ‡ãƒ¼ã‚¿ï¼ˆâœ… **ä¿®æ­£å®Œäº†**ï¼‰

| æ¨©é™ãƒ¬ãƒ™ãƒ« | ç†æƒ³çš„ãªè¡¨ç¤º | å®Ÿéš›ã®è¡¨ç¤º | ä¼šç¤¾IDåˆ¶é™ | çŠ¶æ…‹ |
|-----------|-------------|-----------|----------|------|
| **ç‰¹åˆ¥ç®¡ç†è€…** (`queue@queueu-tech.jp`) | **å…¨ç¤¾ã®å…¨ç¤¾å“¡** | **å…¨ç¤¾ã®å…¨ç¤¾å“¡** | âŒ ãªã— | âœ… æ­£å¸¸ |
| **ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…** (`admin`) | **è‡ªç¤¾ã®ç¤¾å“¡ã®ã¿** | **è‡ªç¤¾ã®ç¤¾å“¡ã®ã¿** | âœ… ã‚ã‚Š | âœ… æ­£å¸¸ |
| **ä¼šç¤¾ç¤¾é•·** (`admin_user`) | **è‡ªç¤¾ã®ç¤¾å“¡ã®ã¿** | **è‡ªç¤¾ã®ç¤¾å“¡ã®ã¿** | âœ… ã‚ã‚Š | âœ… æ­£å¸¸ |
| **ä¼šç¤¾ç®¡ç†è€…** (`user`) | **è‡ªç¤¾ã®ç¤¾å“¡ã®ã¿** | **è‡ªç¤¾ã®ç¤¾å“¡ã®ã¿** | âœ… ã‚ã‚Š | âœ… æ­£å¸¸ |

### 3.3 ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ•ãƒ­ãƒ¼

```python
# main.py ã® admin_get_company_employees é–¢æ•°
is_special_admin = current_user["email"] == "queue@queueu-tech.jp"

if is_special_admin:
    result = await get_company_employees(current_user["id"], db, None)
else:
    # ä¼šç¤¾IDã‚’å–å¾—ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    user_result = select_data("users", filters={"id": current_user["id"]})
    company_id = user_result.data[0].get("company_id")
    result = await get_company_employees(current_user["id"], db, company_id)
```

### 3.4 ä¼šç¤¾IDåˆ¶é™ã®å®Ÿè£…ï¼ˆadmin.pyï¼‰

```python
async def get_company_employees(user_id: str = None, db: Connection = Depends(get_db), company_id: str = None):
    if is_special_admin:
        # å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
        users_result = select_data("users", columns="id, name, email, role, created_at, company_id")
    elif company_id:
        # ç‰¹å®šã®ä¼šç¤¾ã®ç¤¾å“¡ã®ã¿å–å¾—
        result = select_data("users", filters={"company_id": company_id})
```

## 4. ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†æ©Ÿèƒ½ã®æ¨©é™åˆ¶å¾¡

### 4.1 API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /chatbot/api/admin/resources`
- **æ¨©é™ãƒã‚§ãƒƒã‚¯**: `get_admin_or_user`

### 4.2 æ¨©é™åˆ¥è¡¨ç¤ºãƒ‡ãƒ¼ã‚¿

| æ¨©é™ãƒ¬ãƒ™ãƒ« | è¡¨ç¤ºã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ | ä¼šç¤¾IDåˆ¶é™ | å®Ÿè£…å ´æ‰€ |
|-----------|----------------|----------|----------|
| **ç‰¹åˆ¥ç®¡ç†è€…** (`queue@queueu-tech.jp`) | **å…¨ç¤¾ã®å…¨ãƒªã‚½ãƒ¼ã‚¹** | âŒ ãªã— | `get_uploaded_resources_by_company_id(None, db)` |
| **ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…** (`admin`) | **å…¨ç¤¾ã®å…¨ãƒªã‚½ãƒ¼ã‚¹** | âŒ ãªã— | `get_uploaded_resources_by_company_id(None, db)` |
| **ä¼šç¤¾ç¤¾é•·** (`admin_user`) | **è‡ªç¤¾ã®ãƒªã‚½ãƒ¼ã‚¹ã®ã¿** | âœ… ã‚ã‚Š | `get_uploaded_resources_by_company_id(company_id, db)` |
| **ä¼šç¤¾ç®¡ç†è€…** (`user`) | **è‡ªç¤¾ã®ãƒªã‚½ãƒ¼ã‚¹ã®ã¿** | âœ… ã‚ã‚Š | `get_uploaded_resources_by_company_id(company_id, db)` |

### 4.3 ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ•ãƒ­ãƒ¼

```python
# main.py ã® admin_get_resources é–¢æ•°  
is_special_admin = current_user["email"] == "queue@queueu-tech.jp" and current_user.get("is_special_admin", False)

if is_special_admin:
    return await get_uploaded_resources_by_company_id(None, db, uploaded_by=None)
else:
    company_id = current_user.get("company_id")
    return await get_uploaded_resources_by_company_id(company_id, db)
```

### 4.4 ä¼šç¤¾IDåˆ¶é™ã®å®Ÿè£…ï¼ˆresource.pyï¼‰

```python
async def get_uploaded_resources_by_company_id(company_id: str, db: Connection, uploaded_by: str = None):
    query = supabase.table("document_sources").select("id,name,type,page_count,uploaded_at,active,uploaded_by,special")
    
    # ä¼šç¤¾IDã«åŸºã¥ã„ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    if company_id is not None:
        query = query.eq("company_id", company_id)
    
    sources_result = query.execute()
```

## 5. ãã®ä»–ã®ç®¡ç†æ©Ÿèƒ½

### 5.1 ç¤¾å“¡åˆ©ç”¨çŠ¶æ³ï¼ˆEmployee Usageï¼‰

| æ¨©é™ãƒ¬ãƒ™ãƒ« | è¡¨ç¤ºã•ã‚Œã‚‹åˆ©ç”¨çŠ¶æ³ | ä¼šç¤¾IDåˆ¶é™ |
|-----------|-----------------|----------|
| **ç‰¹åˆ¥ç®¡ç†è€…** | **å…¨ç¤¾å“¡ã®åˆ©ç”¨çŠ¶æ³** | âŒ ãªã— |
| **ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…** | **å…¨ç¤¾å“¡ã®åˆ©ç”¨çŠ¶æ³** | âŒ ãªã— |
| **ä¼šç¤¾ç¤¾é•·** | **è‡ªç¤¾ç¤¾å“¡ã®åˆ©ç”¨çŠ¶æ³ã®ã¿** | âœ… ã‚ã‚Š |
| **ä¼šç¤¾ç®¡ç†è€…** | **è‡ªç¤¾ç¤¾å“¡ã®åˆ©ç”¨çŠ¶æ³ã®ã¿** | âœ… ã‚ã‚Š |

### 5.2 åˆ†æãƒ‡ãƒ¼ã‚¿ï¼ˆAnalyticsï¼‰

| æ¨©é™ãƒ¬ãƒ™ãƒ« | åˆ†æå¯¾è±¡ãƒ‡ãƒ¼ã‚¿ | ä¼šç¤¾IDåˆ¶é™ |
|-----------|-------------|----------|
| **ç‰¹åˆ¥ç®¡ç†è€…** | **å…¨ç¤¾ã®ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿** | âŒ ãªã— |
| **ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…** | **å…¨ç¤¾ã®ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿** | âŒ ãªã— |
| **ä¼šç¤¾ç¤¾é•·** | **è‡ªç¤¾ã®ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã®ã¿** | âœ… ã‚ã‚Š |
| **ä¼šç¤¾ç®¡ç†è€…** | **è‡ªç¤¾ã®ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã®ã¿** | âœ… ã‚ã‚Š |

## 6. ğŸš¨ ç™ºè¦‹ã•ã‚ŒãŸé‡å¤§ãªãƒã‚°ã¨å•é¡Œç‚¹

### 6.1 é‡å¤§ãªãƒã‚°

#### 6.1.1 ç¤¾å“¡ç®¡ç†ã§ã®æ¨©é™åˆ¶å¾¡ãƒã‚° âš ï¸ **ç·Šæ€¥ä¿®æ­£ãŒå¿…è¦**
- **ç—‡çŠ¶**: ä»–ç¤¾ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒç¤¾å“¡ç®¡ç†ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹
- **å‰Šé™¤ã«ã¤ã„ã¦**: ä»–ç¤¾ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‰Šé™¤ã¯ã§ããªã„ï¼ˆæ¨©é™åˆ¶å¾¡ãŒæ­£å¸¸å‹•ä½œï¼‰ãŒã€è¡¨ç¤ºã•ã‚Œã‚‹äº‹è‡ªä½“ãŒå•é¡Œ
- **æ ¹æœ¬åŸå› **: æ¨©é™åˆ¤å®šã®äºŒé‡ãƒã‚§ãƒƒã‚¯ã«ã‚ˆã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼

**è©³ç´°ãªå•é¡Œãƒ•ãƒ­ãƒ¼**:
1. `main.py`ï¼ˆLine 2024ï¼‰ã§ç‰¹åˆ¥ç®¡ç†è€…ã§ãªã„ã¨åˆ¤å®š â†’ `company_id`ã‚’å–å¾—
2. `admin.py`ï¼ˆLine 272ï¼‰ã§å†åº¦ç‰¹åˆ¥ç®¡ç†è€…åˆ¤å®šãŒå®Ÿè¡Œã•ã‚Œã‚‹
3. ãªãœã‹`is_special_admin = True`ã«ãªã£ã¦ã—ã¾ã†
4. `company_id`å¼•æ•°ã‚’ç„¡è¦–ã—ã¦å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—

**è©²å½“ã‚³ãƒ¼ãƒ‰ç®‡æ‰€**:
```python
# main.py Line 2024 - ä¸€è²«æ€§ã®ãªã„åˆ¤å®š
is_special_admin = current_user["email"] == "queue@queueu-tech.jp"  # andå¥ãªã—

# ä»–ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆä¾‹ï¼šLine 2048ï¼‰ - æ­£ã—ã„åˆ¤å®š
is_special_admin = current_user["email"] == "queue@queueu-tech.jp" and current_user.get("is_special_admin", False)
```

#### 6.1.2 æ¨©é™éšå±¤ã®æ ¹æœ¬çš„ãªçŸ›ç›¾ âš ï¸ **è¨­è¨ˆä¿®æ­£ãŒå¿…è¦**
ç¾åœ¨ã®å®Ÿè£…ã§ã¯`admin`ï¼ˆã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ï¼‰ãŒä¼šç¤¾åˆ¶é™ã‚’å—ã‘ã¦ãŠã‚Šã€ã“ã‚Œã¯æ¨©é™éšå±¤ã¨ã—ã¦çŸ›ç›¾ã—ã¦ã„ã‚‹ã€‚

**å•é¡Œã®ã‚ã‚‹æ¨©é™éšå±¤ï¼ˆç¾åœ¨ï¼‰**:
- `admin`ï¼ˆã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ï¼‰ â†’ **ä¼šç¤¾åˆ¶é™ã‚ã‚Š**
- `admin_user`ï¼ˆç¤¾é•·ï¼‰ â†’ **ä¼šç¤¾åˆ¶é™ã‚ã‚Š**
- `user`ï¼ˆç®¡ç†è€…ï¼‰ â†’ **ä¼šç¤¾åˆ¶é™ã‚ã‚Š**

**è©²å½“æ©Ÿèƒ½**:
- ãƒãƒ£ãƒƒãƒˆå±¥æ­´ï¼ˆLine 1494ã§`is_admin`ãªã®ã«ä¼šç¤¾åˆ¶é™ï¼‰
- CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆLine 818ã§`is_admin`ãŒä¼šç¤¾åˆ¶é™ï¼‰
- ãƒ—ãƒ©ãƒ³å±¥æ­´ï¼ˆadminãŒä¼šç¤¾åˆ¶é™ã‚’å—ã‘ã‚‹ï¼‰

#### 6.1.3 CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ã®ä¸é©åˆ‡ãªã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ âš ï¸ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ**
```python
# Line 799 - ç¤¾å“¡ã‚‚CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½
is_employee = current_user["role"] == "employee"  # â† ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ
```
ç¤¾å“¡ãŒãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã®ã¯ä¸é©åˆ‡ã€‚

#### 6.1.4 ç‰¹å®šä¼šç¤¾ã¸ã®ä¸é©åˆ‡ãªç‰¹æ¨©ä»˜ä¸ âš ï¸ **å…¬å¹³æ€§ã®å•é¡Œ**
```python
# Line 2953 - ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸä¼šç¤¾ID
is_special_company_user = current_user.get("company_id") == "77acc2e2-ce67-458d-bd38-7af0476b297a"
```
ç‰¹å®šã®ä¼šç¤¾IDã«ã®ã¿ãƒ—ãƒ©ãƒ³å±¥æ­´ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ä¸ãˆã¦ã„ã‚‹ã®ã¯å…¬å¹³æ€§ã«å•é¡ŒãŒã‚ã‚‹ã€‚

#### 6.1.2 æ¨©é™åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®ä¸æ•´åˆ
- **å•é¡Œ**: ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚ˆã£ã¦ç•°ãªã‚‹ç‰¹åˆ¥ç®¡ç†è€…åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
- **å½±éŸ¿**: ä¸€éƒ¨æ©Ÿèƒ½ã§æ¨©é™åˆ¶å¾¡ãŒç„¡åŠ¹åŒ–ã•ã‚Œã‚‹å¯èƒ½æ€§
- **å¯¾ç­–**: æ¨©é™åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®çµ±ä¸€ãŒå¿…è¦

### 6.2 ãã®ä»–ã®æ½œåœ¨çš„å•é¡Œ

#### 6.2.1 ä¼šç¤¾IDãŒnullã®å ´åˆã®å‡¦ç†
- **å•é¡Œ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®`company_id`ãŒnullã®å ´åˆã€æ„å›³ã—ãªã„ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§
- **å½±éŸ¿ç®‡æ‰€**: å…¨ã¦ã®ç®¡ç†æ©Ÿèƒ½
- **å¯¾ç­–**: ä¼šç¤¾IDãŒnullã®å ´åˆã®æ˜ç¤ºçš„ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¿½åŠ 

#### 6.2.2 ç‰¹åˆ¥ç®¡ç†è€…ã®åˆ¤å®šæ–¹æ³•
- **å•é¡Œ**: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã®åˆ¤å®šã®ãŸã‚ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´æ™‚ã«ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒå¤±ã‚ã‚Œã‚‹
- **å¯¾ç­–**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã®å°‚ç”¨ãƒ•ãƒ©ã‚°ã«ã‚ˆã‚‹ç®¡ç†ã‚’æ¨å¥¨

### 6.2 æ¨å¥¨ã•ã‚Œã‚‹æ”¹å–„ç‚¹

#### 6.2.1 æ¨©é™ãƒã‚§ãƒƒã‚¯ã®ä¸€å…ƒåŒ–
```python
def check_data_access_permission(current_user, target_company_id=None):
    """ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹çµ±ä¸€é–¢æ•°"""
    is_special_admin = current_user["email"] == "queue@queueu-tech.jp"
    is_admin = current_user["role"] == "admin"
    
    if is_special_admin or is_admin:
        return {"can_access": True, "company_filter": None}
    
    user_company_id = current_user.get("company_id")
    if not user_company_id:
        raise HTTPException(status_code=403, detail="ä¼šç¤¾IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
    
    return {"can_access": True, "company_filter": user_company_id}
```

#### 6.2.2 ãƒ­ã‚°å‡ºåŠ›ã®å¼·åŒ–
- æ¨©é™ãƒã‚§ãƒƒã‚¯ã®çµæœã‚’ãƒ­ã‚°ã«è¨˜éŒ²
- ç•°å¸¸ãªã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡ºæ©Ÿèƒ½

## 7. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### 7.1 å®šæœŸç¢ºèªé …ç›®

- [ ] å„APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§é©åˆ‡ãªæ¨©é™ãƒã‚§ãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ä¼šç¤¾IDã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã‹  
- [ ] ç¤¾å“¡ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒç®¡ç†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã“ã¨ã‚’ç¢ºèª
- [ ] ç‰¹åˆ¥ç®¡ç†è€…ä»¥å¤–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»–ç¤¾ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã“ã¨ã‚’ç¢ºèª

### 7.2 ãƒ†ã‚¹ãƒˆæ–¹æ³•

```bash
# å„æ¨©é™ãƒ¬ãƒ™ãƒ«ã§ã®APIãƒ†ã‚¹ãƒˆä¾‹
curl -u "user@company1.com:password" "http://localhost:8000/chatbot/api/admin/chat-history"
curl -u "admin@company2.com:password" "http://localhost:8000/chatbot/api/admin/company-employees"
curl -u "employee@company1.com:password" "http://localhost:8000/chatbot/api/admin/resources"  # ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã¹ã
```

## 8. ã¾ã¨ã‚

### 8.1 ä¿®æ­£å®Œäº†ï¼šæ¨©é™åˆ¶å¾¡ã®çµ±ä¸€åŒ–

**ğŸ‰ Workmateç®¡ç†ç”»é¢ã®æ¨©é™åˆ¶å¾¡å•é¡ŒãŒå®Œå…¨ã«ä¿®æ­£ã•ã‚Œã¾ã—ãŸ**

#### âœ… **ä¿®æ­£å®Œäº†ã—ãŸæ©Ÿèƒ½**
1. **ç¤¾å“¡ç®¡ç†**: ä»–ç¤¾ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºå•é¡Œã‚’è§£æ±º
2. **CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**: æ¨©é™éšå±¤ã‚’çµ±ä¸€ã—ã€ç¤¾å“¡ã‚¢ã‚¯ã‚»ã‚¹ã‚’é©åˆ‡ã«åˆ¶é™
3. **ãƒãƒ£ãƒƒãƒˆå±¥æ­´**: è¡¨ç¤ºã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®æ¨©é™éšå±¤ã‚’çµ±ä¸€
4. **ãƒ—ãƒ©ãƒ³å±¥æ­´**: ç‰¹å®šä¼šç¤¾ã®ä¸å½“ãªç‰¹æ¨©ã‚’å‰Šé™¤
5. **ãƒãƒ£ãƒƒãƒˆåˆ†æ**: admin_userãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ã€æ¨©é™éšå±¤ã‚’çµ±ä¸€
6. **æ¨©é™åˆ¤å®š**: å…¨æ©Ÿèƒ½ã§çµ±ä¸€ã•ã‚ŒãŸãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…

#### âœ… **æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹æ©Ÿèƒ½**
1. **ç¤¾å“¡ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ã¯ç®¡ç†ç”»é¢ã«ä¸€åˆ‡ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„
2. **å‰Šé™¤æ¨©é™**ã¯æ­£ã—ãåˆ¶å¾¡ã•ã‚Œã¦ã„ã‚‹
3. **ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†**ã¯é©åˆ‡ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹
4. **ç¤¾å“¡åˆ©ç”¨çŠ¶æ³**ã¯é©åˆ‡ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹

### 8.2 çµ±ä¸€ã•ã‚ŒãŸæ¨©é™éšå±¤

#### **ğŸ”§ ä¿®æ­£å¾Œã®æ­£ã—ã„æ¨©é™éšå±¤**

| æ¨©é™ãƒ¬ãƒ™ãƒ« | ã‚¢ã‚¯ã‚»ã‚¹ç¯„å›² | å¯¾è±¡æ©Ÿèƒ½ |
|-----------|-------------|----------|
| **ç‰¹åˆ¥ç®¡ç†è€…** (`queue@queueu-tech.jp`) | ğŸŒ **å…¨ç¤¾ã®ãƒ‡ãƒ¼ã‚¿** | å…¨æ©Ÿèƒ½ |
| **ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…** (`admin`) | ğŸŒ **å…¨ç¤¾ã®ãƒ‡ãƒ¼ã‚¿** | å…¨æ©Ÿèƒ½ |
| **ä¼šç¤¾ç¤¾é•·** (`admin_user`) | ğŸ¢ **è‡ªç¤¾ãƒ‡ãƒ¼ã‚¿ã®ã¿** | ç®¡ç†æ©Ÿèƒ½ |
| **ä¼šç¤¾ç®¡ç†è€…** (`user`) | ğŸ¢ **è‡ªç¤¾ãƒ‡ãƒ¼ã‚¿ã®ã¿** | ç®¡ç†æ©Ÿèƒ½ |
| **ç¤¾å“¡** (`employee`) | âŒ **ç®¡ç†ç”»é¢ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯** | ãªã— |

#### **ğŸ“‹ æ©Ÿèƒ½åˆ¥æ¨©é™ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ï¼ˆä¿®æ­£å¾Œï¼‰**

| æ©Ÿèƒ½ | ç‰¹åˆ¥ç®¡ç†è€… | admin | admin_user | user | employee |
|------|-----------|-------|------------|------|----------|
| ç¤¾å“¡ç®¡ç† | ğŸŒ å…¨ç¤¾å“¡ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | âŒ |
| ãƒãƒ£ãƒƒãƒˆå±¥æ­´ | ğŸŒ å…¨ãƒ‡ãƒ¼ã‚¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | âŒ |
| CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ | ğŸŒ å…¨ãƒ‡ãƒ¼ã‚¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | âŒ |
| ãƒ—ãƒ©ãƒ³å±¥æ­´ | ğŸŒ å…¨ãƒ‡ãƒ¼ã‚¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | âŒ | âŒ |
| ãƒãƒ£ãƒƒãƒˆåˆ†æ | ğŸŒ å…¨ãƒ‡ãƒ¼ã‚¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | âŒ |
| ãƒªã‚½ãƒ¼ã‚¹ç®¡ç† | ğŸŒ å…¨ãƒ‡ãƒ¼ã‚¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | ğŸ¢ è‡ªç¤¾ã®ã¿ | âŒ |

### 8.3 å®Ÿè£…ã•ã‚ŒãŸæ”¹å–„ç‚¹

#### **ğŸ”§ æŠ€è¡“çš„æ”¹å–„**
1. **æ¨©é™åˆ¤å®šã®çµ±ä¸€åŒ–**: å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ä¸€è²«ã—ãŸåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
2. **ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®è¿½åŠ **: æ¨©é™åˆ¶å¾¡ã®å‹•ä½œã‚’è¿½è·¡å¯èƒ½
3. **äºŒé‡ãƒã‚§ãƒƒã‚¯ã®å‰Šé™¤**: æ¨©é™åˆ¤å®šã®çŸ›ç›¾ã‚’è§£æ¶ˆ
4. **ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ç‰¹æ¨©ã®å‰Šé™¤**: å…¬å¹³ãªæ¨©é™åˆ¶å¾¡ã‚’å®Ÿç¾

#### **ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**
1. **æƒ…å ±æ¼æ´©ãƒªã‚¹ã‚¯ã®è§£æ¶ˆ**: ä»–ç¤¾ãƒ‡ãƒ¼ã‚¿ã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²æ­¢
2. **é©åˆ‡ãªæ¨©é™æ˜‡æ ¼é˜²æ­¢**: ç¤¾å“¡ã®ç®¡ç†ç”»é¢ã‚¢ã‚¯ã‚»ã‚¹ã‚’å®Œå…¨åˆ¶é™
3. **ä¼šç¤¾ãƒ‡ãƒ¼ã‚¿åˆ†é›¢**: é©åˆ‡ãªä¼šç¤¾IDåˆ¶é™ã®å®Ÿè£…

### 8.4 ä»Šå¾Œã®ä¿å®ˆã«ã¤ã„ã¦

#### **âœ… æ¨©é™åˆ¶å¾¡ã®å®‰å…¨æ€§**
- å…¨æ©Ÿèƒ½ã§çµ±ä¸€ã•ã‚ŒãŸæ¨©é™åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯
- é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨æ¨©é™é™æ ¼å‡¦ç†
- ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã«ã‚ˆã‚‹å‹•ä½œè¿½è·¡

#### **ğŸ” ç›£è¦–æ¨å¥¨é …ç›®**
- å®šæœŸçš„ãªæ¨©é™åˆ¶å¾¡ãƒ†ã‚¹ãƒˆ
- ãƒ­ã‚°ã®ç›£è¦–ï¼ˆæ¨©é™ã‚¨ãƒ©ãƒ¼ã®æ¤œå‡ºï¼‰
- æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã®æ¨©é™åˆ¶å¾¡ãƒã‚§ãƒƒã‚¯

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´1æœˆï¼ˆãƒã‚°èª¿æŸ»ã«ã‚ˆã‚Šæ›´æ–°ï¼‰ 
**ä½œæˆè€…**: AI Assistant  
**ãƒ¬ãƒ“ãƒ¥ãƒ¼**: âš ï¸ **ç·Šæ€¥ãƒã‚°ä¿®æ­£ãŒå¿…è¦**  
**é‡è¦åº¦**: ğŸš¨ **é«˜ï¼ˆæƒ…å ±æ¼æ´©ãƒªã‚¹ã‚¯ï¼‰** 