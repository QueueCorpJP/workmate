===============================================================
ä»–ã®APIãŒå‹•ä½œã—ã¦CSVãƒ»ãƒ—ãƒ©ãƒ³å±¥æ­´ãŒå‹•ä½œã—ãªã„ç†ç”± - èªè¨¼æ¨©é™å•é¡Œåˆ†æ
===============================================================

ä½œæˆæ—¥: 2025å¹´1æœˆ7æ—¥
å•é¡Œ: ä»–ã®APIã¯æ­£å¸¸å‹•ä½œã€CSVãƒ»ãƒ—ãƒ©ãƒ³å±¥æ­´ã®ã¿æœ¬ç•ªç’°å¢ƒã§å¤±æ•—

===============================================================
1. æŠ€è¡“çš„ãªæ ¹æœ¬åŸå› 
===============================================================

ã€çµè«–ã€‘
å•é¡Œã¯ç’°å¢ƒè¨­å®šã§ã¯ãªãã€**èªè¨¼ãƒ»æ¨©é™ãƒ¬ãƒ™ãƒ«ã®é•ã„**ã«ã‚ã‚‹ã€‚

ã€å‹•ä½œã™ã‚‹APIã€‘âœ…
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³
- åŸºæœ¬çš„ãªç®¡ç†æ©Ÿèƒ½
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

ã€å‹•ä½œã—ãªã„APIã€‘âŒ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- ãƒ—ãƒ©ãƒ³å±¥æ­´
- ãƒ“ã‚¸ãƒã‚¹åˆ†æï¼ˆè©³ç´°åˆ†æï¼‰

===============================================================
2. èªè¨¼ãƒ¬ãƒ™ãƒ«ã®é•ã„è©³ç´°åˆ†æ
===============================================================

ã€å‹•ä½œã™ã‚‹API - åŸºæœ¬èªè¨¼ã€‘âœ…
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…:
@app.post("/chatbot/api/chat")
async def chat_endpoint(current_user=Depends(get_current_user)):

èªè¨¼è¦ä»¶:
- åŸºæœ¬çš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã®ã¿
- role = "employee", "user", "admin" ã™ã¹ã¦åˆ©ç”¨å¯èƒ½
- ç‰¹åˆ¥ãªæ¨©é™ãƒã‚§ãƒƒã‚¯ãªã—

ã€å‹•ä½œã—ãªã„API - ç®¡ç†è€…èªè¨¼ã€‘âŒ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â–  CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…:
@app.get("/chatbot/api/admin/chat-history/csv")
async def export_csv(current_user=Depends(get_admin_or_user)):

è¿½åŠ èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ (main.py 1060-1061è¡Œ):
is_admin = current_user["role"] == "admin"
is_special_admin = current_user["email"] in ["queue@queuefood.co.jp", "queue@queue-tech.jp"] and current_user.get("is_special_admin", False)

â–  ãƒ—ãƒ©ãƒ³å±¥æ­´
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…:
@app.get("/chatbot/api/plan-history")
async def get_plan_history(current_user=Depends(get_current_user)):

è¿½åŠ èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ (main.py 1032-1033è¡Œ):
if current_user["role"] in ["admin"] or current_user["email"] in ["queue@queuefood.co.jp", "queue@queue-tech.jp"]:

â–  ãƒ“ã‚¸ãƒã‚¹åˆ†æ
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…:
@app.post("/chatbot/api/admin/detailed-analysis")
async def detailed_analysis(current_user=Depends(get_admin_or_user)):

===============================================================
3. æœ¬ç•ªç’°å¢ƒã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™çŠ¶æ³
===============================================================

ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã€‘âœ… é–‹ç™ºç”¨è¨­å®š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç®¡ç†è€…æ¨©é™ (role = "admin") ã‚’æŒã¤å ´åˆãŒå¤šã„
- ç‰¹åˆ¥ç®¡ç†è€…ãƒ•ãƒ©ã‚° (is_special_admin = True) ãŒè¨­å®šã•ã‚Œã‚‹
- é–‹ç™ºç”¨ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç‰¹åˆ¥ç®¡ç†è€…ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹

ã€æœ¬ç•ªç’°å¢ƒã€‘âŒ ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- ã»ã¨ã‚“ã©ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ role = "user" ã¾ãŸã¯ "employee"
- ç‰¹åˆ¥ç®¡ç†è€…ãƒ•ãƒ©ã‚° (is_special_admin) ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„
- ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸç‰¹åˆ¥ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ä»¥å¤–ã¯ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦

ã€ç‰¹åˆ¥ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ï¼‰ã€‘
- queue@queuefood.co.jp
- queue@queue-tech.jp

===============================================================
4. å…·ä½“çš„ãªèªè¨¼å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³
===============================================================

ã€CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒCSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: api.get('/admin/chat-history/csv')
3. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: get_admin_or_user() ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
4. æ¨©é™ãƒã‚§ãƒƒã‚¯:
   - current_user["role"] != "admin" âŒ
   - current_user["email"] not in ç‰¹åˆ¥ãƒªã‚¹ãƒˆ âŒ
   - current_user.get("is_special_admin", False) = False âŒ
5. çµæœ: ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ â†’ æ©Ÿèƒ½ãŒå‹•ä½œã—ãªã„

ã€ãƒ—ãƒ©ãƒ³å±¥æ­´å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. ãƒ—ãƒ©ãƒ³å±¥æ­´ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: api.get("/plan-history")
3. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: get_current_user() ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª âœ…
4. æ¨©é™ãƒã‚§ãƒƒã‚¯:
   - current_user["role"] not in ["admin"] âŒ
   - current_user["email"] not in ç‰¹åˆ¥ãƒªã‚¹ãƒˆ âŒ
5. çµæœ: ç©ºã®ãƒ‡ãƒ¼ã‚¿ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ â†’ è¡¨ç¤ºã•ã‚Œãªã„

===============================================================
5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ã®å•é¡Œç‚¹
===============================================================

ã€ãƒ“ã‚¸ãƒã‚¹åˆ†æã®è¿½åŠ å•é¡Œã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ãƒ•ã‚¡ã‚¤ãƒ«: AnalysisTab.tsx (115è¡Œç›®)

å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰:
const response = await api.post(`${import.meta.env.VITE_API_URL}/admin/detailed-analysis`, {
  prompt: BUSINESS_ANALYSIS_PROMPT
});

å•é¡Œ:
1. ç›´æ¥ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ï¼ˆaxiosã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ã‚ãªã„ï¼‰
2. èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œãªã„å¯èƒ½æ€§
3. ä»–ã®APIå‘¼ã³å‡ºã—ã¨ä¸€è²«æ€§ãŒãªã„

æ­£ã—ã„å®Ÿè£…:
const response = await api.post('/admin/detailed-analysis', {
  prompt: BUSINESS_ANALYSIS_PROMPT
});

===============================================================
6. è§£æ±ºæ–¹æ³•ï¼ˆå„ªå…ˆé †ä½ä»˜ãï¼‰
===============================================================

ã€è§£æ±ºæ–¹æ³•1: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£ã€‘ğŸ”§ æ¨å¥¨
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â–  CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã®ä¿®æ­£
ç¾åœ¨: @app.get("/chatbot/api/admin/chat-history/csv", dependencies=[Depends(get_admin_or_user)])
ä¿®æ­£: @app.get("/chatbot/api/admin/chat-history/csv", dependencies=[Depends(get_current_user)])

æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤ã¾ãŸã¯ç·©å’Œ:
# ä¿®æ­£å‰
is_admin = current_user["role"] == "admin"
is_special_admin = current_user["email"] in ["queue@queuefood.co.jp", "queue@queue-tech.jp"] and current_user.get("is_special_admin", False)

# ä¿®æ­£å¾Œï¼ˆrole = "user" ã‚‚è¨±å¯ï¼‰
is_authorized = current_user["role"] in ["admin", "user"] or current_user["email"] in ["queue@queuefood.co.jp", "queue@queue-tech.jp"]

â–  ãƒ—ãƒ©ãƒ³å±¥æ­´ã®ä¿®æ­£
ç¾åœ¨ã®æ¨©é™ãƒã‚§ãƒƒã‚¯:
if current_user["role"] in ["admin"] or current_user["email"] in ["queue@queuefood.co.jp", "queue@queue-tech.jp"]:

ä¿®æ­£å¾Œ:
if current_user["role"] in ["admin", "user"] or current_user["email"] in ["queue@queuefood.co.jp", "queue@queue-tech.jp"]:

ã€è§£æ±ºæ–¹æ³•2: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±ä¸€ã€‘ğŸ”§ å¿…è¦
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
AnalysisTab.tsxã®ä¿®æ­£:
ä¿®æ­£å‰:
const response = await api.post(`${import.meta.env.VITE_API_URL}/admin/detailed-analysis`, {

ä¿®æ­£å¾Œ:
const response = await api.post('/admin/detailed-analysis', {

ã€è§£æ±ºæ–¹æ³•3: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™æ›´æ–°ã€‘ğŸ”§ ä»£æ›¿æ¡ˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æœ¬ç•ªç’°å¢ƒã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã§:
UPDATE users SET role = 'admin' WHERE role = 'user' AND email IN ('ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹');

ã¾ãŸã¯

UPDATE users SET is_special_admin = TRUE WHERE email IN ('ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹');

===============================================================
7. ãªãœä»–ã®APIã¯å‹•ä½œã™ã‚‹ã®ã‹ - è©³ç´°èª¬æ˜
===============================================================

ã€ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã€‘âœ… å‹•ä½œã™ã‚‹ç†ç”±
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- èªè¨¼: Depends(get_current_user) ã®ã¿
- æ¨©é™ãƒã‚§ãƒƒã‚¯: ãªã—
- å¿…è¦role: employee, user, admin ã™ã¹ã¦OK
- å®Ÿè£…: ã‚·ãƒ³ãƒ—ãƒ«ãªåŸºæœ¬èªè¨¼ã®ã¿

ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€‘âœ… å‹•ä½œã™ã‚‹ç†ç”±
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- èªè¨¼: Depends(get_current_user) ã®ã¿
- æ¨©é™ãƒã‚§ãƒƒã‚¯: role = "user" ã¾ãŸã¯ "admin" ã§ååˆ†
- æœ¬ç•ªç’°å¢ƒã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚role = "user"ã‚’æŒã£ã¦ã„ã‚‹

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ã€‘âœ… ä¸€éƒ¨å‹•ä½œã™ã‚‹ç†ç”±
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- åŸºæœ¬çš„ãªè¡¨ç¤º: get_current_user ã§ååˆ†
- ä½œæˆãƒ»å‰Šé™¤: adminæ¨©é™ãŒå¿…è¦ï¼ˆã“ã‚Œã‚‰ã¯å‹•ä½œã—ãªã„å¯èƒ½æ€§ï¼‰

ã€CSVãƒ»ãƒ—ãƒ©ãƒ³å±¥æ­´ã€‘âŒ å‹•ä½œã—ãªã„ç†ç”±
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- èªè¨¼: get_admin_or_user ã¾ãŸã¯ å³ã—ã„æ¨©é™ãƒã‚§ãƒƒã‚¯
- æ¨©é™ãƒã‚§ãƒƒã‚¯: admin role ã¾ãŸã¯ç‰¹åˆ¥ãƒ¡ãƒ¼ãƒ«å¿…é ˆ
- æœ¬ç•ªãƒ¦ãƒ¼ã‚¶ãƒ¼: ã“ã‚Œã‚‰ã®æ¡ä»¶ã‚’æº€ãŸã•ãªã„

===============================================================
8. æ¨å¥¨å¯¾å¿œç­–
===============================================================

ã€å³åº§ã«å®Ÿè¡Œã™ã¹ãä¿®æ­£ã€‘âš¡
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’ç·©å’Œ
   - role = "user" ã‚‚CSVãƒ»ãƒ—ãƒ©ãƒ³å±¥æ­´ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯
2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®APIå‘¼ã³å‡ºã—çµ±ä¸€
   - AnalysisTab.tsxã®URLæ§‹ç¯‰æ–¹æ³•ã‚’ä¿®æ­£

ã€æ¤œè¨¼æ–¹æ³•ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. æœ¬ç•ªç’°å¢ƒã§ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆrole = "user"ï¼‰ã§ãƒ­ã‚°ã‚¤ãƒ³
2. ç®¡ç†è€…ãƒ‘ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹
3. CSVãƒ»ãƒ—ãƒ©ãƒ³å±¥æ­´æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆ
4. æ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª

ã€é•·æœŸçš„æ”¹å–„ã€‘ğŸ“‹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. æ¨©é™ç®¡ç†ã®ä½“ç³»åŒ–
2. role-based access control ã®è¦‹ç›´ã—
3. æ©Ÿèƒ½åˆ¥æ¨©é™è¨­å®šã®å°å…¥

===============================================================
ã¾ã¨ã‚
===============================================================

ã€å•é¡Œã®æœ¬è³ªã€‘
ç’°å¢ƒè¨­å®šã§ã¯ãªãã€èªè¨¼ãƒ»æ¨©é™ãƒ¬ãƒ™ãƒ«ã®é•ã„ãŒåŸå› ã€‚
CSVãƒ»ãƒ—ãƒ©ãƒ³å±¥æ­´ã¯ç®¡ç†è€…å°‚ç”¨ã¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãŒã€
ä»–ã®APIã¯ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã€‚

ã€è§£æ±ºã®æ–¹é‡ã€‘
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’ç·©å’Œã—ã€
role = "user" ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹ã€‚

===============================================================