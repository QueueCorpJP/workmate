name: Test SSH Connection

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

jobs:
  test-connection:
    runs-on: ubuntu-latest

    steps:
    - name: Test Secrets
      run: |
        echo "ğŸ” Secretsç¢ºèª (å€¤ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“):"
        echo "EC2_HOST ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹: ${{ secrets.EC2_HOST != '' }}"
        echo "EC2_USER ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹: ${{ secrets.EC2_USER != '' }}"
        echo "EC2_PATH ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹: ${{ secrets.EC2_PATH != '' }}"
        echo "EC2_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹: ${{ secrets.EC2_KEY != '' }}"

    - name: Test Host Resolution and Network
      run: |
        echo "ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨ºæ–­:"
        if [ -n "${{ secrets.EC2_HOST }}" ]; then
          echo "ãƒ›ã‚¹ãƒˆ: ${{ secrets.EC2_HOST }}"
          
          echo "ğŸ“¡ Pingãƒ†ã‚¹ãƒˆ:"
          ping -c 3 ${{ secrets.EC2_HOST }} || echo "âŒ Pingã«å¤±æ•—"
          
          echo "ğŸ”Œ ãƒãƒ¼ãƒˆ22ã®ãƒ†ã‚¹ãƒˆ:"
          timeout 10 bash -c "</dev/tcp/${{ secrets.EC2_HOST }}/22" && echo "âœ… ãƒãƒ¼ãƒˆ22ã¯é–‹ã„ã¦ã„ã¾ã™" || echo "âŒ ãƒãƒ¼ãƒˆ22ã«æ¥ç¶šã§ãã¾ã›ã‚“"
          
          echo "ğŸ•µï¸ netcatã«ã‚ˆã‚‹ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ:"
          nc -zv ${{ secrets.EC2_HOST }} 22 || echo "âŒ netcatã§ã‚‚ãƒãƒ¼ãƒˆ22ã«æ¥ç¶šã§ãã¾ã›ã‚“"
          
        else
          echo "âŒ EC2_HOST ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
        fi

    - name: Test SSH Connection with Verbose Output
      run: |
        if [ -n "${{ secrets.EC2_HOST }}" ] && [ -n "${{ secrets.EC2_USER }}" ] && [ -n "${{ secrets.EC2_KEY }}" ]; then
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          echo "ğŸ”— SSHæ¥ç¶šãƒ†ã‚¹ãƒˆ (è©³ç´°ãƒ¢ãƒ¼ãƒ‰):"
          ssh -vvv -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'SSHæ¥ç¶šæˆåŠŸ!'" 2>&1 || echo "âŒ SSHæ¥ç¶šå¤±æ•—"
        else
          echo "âŒ å¿…è¦ãªSecretsãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
        fi

    - name: Show System Information
      run: |
        echo "ğŸ–¥ï¸ GitHub Actionsç’°å¢ƒæƒ…å ±:"
        echo "OS: $(uname -a)"
        echo "IPæƒ…å ±:"
        ip addr show || ifconfig
        echo "DNSè¨­å®š:"
        cat /etc/resolv.conf 