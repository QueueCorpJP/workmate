name: Deploy Backend

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Test workflow
      run: |
        echo "ğŸš€ GitHub Actionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå‹•ä½œã—ã¦ã„ã¾ã™"
        echo "ğŸ“‚ ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å†…å®¹:"
        ls -la
        echo ""
        echo "ğŸ“ Chatbot-backend-mainãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª:"
        if [ -d "Chatbot-backend-main" ]; then
          echo "âœ… Chatbot-backend-mainãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã™"
          ls -la Chatbot-backend-main/
        else
          echo "âŒ Chatbot-backend-mainãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi

    - name: Setup SSH
      run: |
        echo "ğŸ”‘ SSHè¨­å®šé–‹å§‹..."
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
        
        echo "ğŸ”— SSHæ¥ç¶šãƒ†ã‚¹ãƒˆ:"
        ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'SSHæ¥ç¶šæˆåŠŸ'" || {
          echo "âŒ SSHæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
        }
        echo "âœ… SSHæ¥ç¶šãŒæˆåŠŸã—ã¾ã—ãŸ"

    - name: Prepare backend files
      run: |
        echo "ğŸ“¦ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™..."
        cd Chatbot-backend-main
        
        # ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ã—ã¦ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ
        tar --exclude='.git' --exclude='__pycache__' --exclude='*.pyc' --exclude='.env' \
            -czf ../backend.tar.gz .
        
        echo "ğŸ“¦ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å†…å®¹ç¢ºèª:"
        tar -tzf ../backend.tar.gz | head -20
        
        echo "âœ… ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™å®Œäº†"

    - name: Deploy backend
      run: |
        echo "ğŸ“¤ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€é–‹å§‹..."
        
        # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ã‚µãƒ¼ãƒãƒ¼ã«è»¢é€
        scp -o ConnectTimeout=30 -o ServerAliveInterval=10 backend.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/
        
        echo "ğŸš€ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ..."
        ssh -o ConnectTimeout=30 -o ServerAliveInterval=10 ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
          set -e
          
          # ãƒ‘ã‚¹è¨­å®š
          DEPLOY_PATH="${{ secrets.EC2_PATH }}"
          
          echo "ğŸ“‚ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ã‚¹: $DEPLOY_PATH"
          echo "ğŸ‘¤ ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: $(whoami)"
          echo "ğŸ“‚ ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)"
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæº–å‚™
          echo "ğŸ—‚ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæº–å‚™..."
          mkdir -p $DEPLOY_PATH
          cd $DEPLOY_PATH
          
          # æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
          echo "ğŸ’¾ æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—..."
          if [ -f ".env" ]; then
            cp .env .env.backup
            echo "ç’°å¢ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ"
          fi
          
          # æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å±•é–‹
          echo "ğŸ“¦ ãƒ•ã‚¡ã‚¤ãƒ«å±•é–‹..."
          tar -xzf /tmp/backend.tar.gz
          
          # ç’°å¢ƒãƒ•ã‚¡ã‚¤ãƒ«å¾©å…ƒ
          if [ -f ".env.backup" ]; then
            mv .env.backup .env
            echo "ç’°å¢ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å…ƒã—ã¾ã—ãŸ"
          fi
          
          # Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          echo "ğŸ“¥ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«..."
          if [ -f "requirements.txt" ]; then
            # ä»®æƒ³ç’°å¢ƒãŒã‚ã‚‹å ´åˆã¯åˆ©ç”¨
            if [ -d "venv" ]; then
              source venv/bin/activate
            fi
            pip install -r requirements.txt
            echo "Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
          else
            echo "requirements.txtãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
          
          # PM2ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•
          echo "ğŸ”„ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•..."
          if command -v pm2 >/dev/null 2>&1; then
            # PM2ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
            pm2 list
            
            # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åã‚’ç¢ºèªã—ã¦å†èµ·å‹•
            if pm2 describe workmate-backend >/dev/null 2>&1; then
              echo "workmate-backend ã‚’å†èµ·å‹•ã—ã¾ã™..."
              pm2 restart workmate-backend
            elif pm2 describe app >/dev/null 2>&1; then
              echo "app ã‚’å†èµ·å‹•ã—ã¾ã™..."
              pm2 restart app
            else
              echo "æ–°ã—ã„PM2ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹å§‹ã—ã¾ã™..."
              pm2 start main.py --name workmate-backend
            fi
            
            # PM2ãƒ—ãƒ­ã‚»ã‚¹çŠ¶æ…‹ç¢ºèª
            pm2 list
            pm2 save
          else
            echo "PM2ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç›´æ¥Pythonã§èµ·å‹•ã‚’è©¦è¡Œã—ã¾ã™..."
            nohup python main.py > app.log 2>&1 &
          fi
          
          echo "ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤çµæœç¢ºèª:"
          ls -la $DEPLOY_PATH/ | head -20
          
          echo "ğŸ§¹ ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤..."
          rm -f /tmp/backend.tar.gz
          
          echo "âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
        ENDSSH
        
        echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹å®Œäº†"

    - name: Verify deployment
      run: |
        echo "ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼..."
        ssh -o ConnectTimeout=15 ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
          echo 'ğŸŒ ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª:'
          ps aux | grep -E '(python|main\.py)' | grep -v grep || echo 'Pythonãƒ—ãƒ­ã‚»ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
          echo ''
          echo 'ğŸ”§ PM2ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª:'
          if command -v pm2 >/dev/null 2>&1; then
            pm2 list
          else
            echo 'PM2ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
          fi
          echo ''
          echo 'ğŸš€ å®Ÿè¡Œä¸­ã®Webã‚µãƒ¼ãƒãƒ¼:'
          netstat -tlnp | grep -E ':(8083|8000|3000)' || echo 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
        " || echo "âš ï¸ æ¤œè¨¼ã§ã„ãã¤ã‹ã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
        
        echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼å®Œäº†"