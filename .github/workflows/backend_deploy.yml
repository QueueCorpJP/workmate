name: Deploy Backend

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
    - name: Free up disk space
      run: |
        echo "ğŸ§¹ ãƒ‡ã‚£ã‚¹ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ã—ã¦ã„ã¾ã™..."
        echo "åˆæœŸã®ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨çŠ¶æ³:"
        df -h
        
        # ä¸è¦ãªãƒ„ãƒ¼ãƒ«ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/local/share/chromium
        sudo rm -rf /usr/share/swift
        
        # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        docker rmi $(docker image ls -q) || true
        
        # APTã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        sudo apt-get clean
        sudo apt-get autoremove -y
        
        echo "ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œã®ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨çŠ¶æ³:"
        df -h
        
    - name: Checkout
      uses: actions/checkout@v3

    # ------------- æ–°ã‚¹ãƒ†ãƒƒãƒ—: SSHè¨­å®š -------------
    - name: Setup SSH
      run: |
        echo "ğŸ”‘ SSHè¨­å®šé–‹å§‹..."
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_KEY }}" | tr -d '\r' | sed 's/\\n/\n/g' > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
        
        echo "ğŸ”— SSHæ¥ç¶šãƒ†ã‚¹ãƒˆ:"
        ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'SSHæ¥ç¶šæˆåŠŸ'" || { echo "âŒ SSHæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ"; exit 1; }
        echo "âœ… SSHæ¥ç¶šãŒæˆåŠŸã—ã¾ã—ãŸ"

    # ------------- æ–°ã‚¹ãƒ†ãƒƒãƒ—: ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ -------------
    - name: Create remote deployment directory
      run: |
        echo "ğŸ“‚ ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦ã„ã¾ã™..."
        REMOTE_BASE="/home/${{ secrets.EC2_USER }}/workmate"
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p $REMOTE_BASE/Chatbot-backend-main"
        echo "âœ… ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆå®Œäº†"

    # ------------- æ–°ã‚¹ãƒ†ãƒƒãƒ—: å·®åˆ†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (ãƒã‚¤ãƒ†ã‚£ãƒ– scp) -------------
    - name: Copy backend source to EC2 (native scp)
      run: |
        echo "ğŸ“¤ scp ã§å·®åˆ†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹..."
        REMOTE_BASE="/home/${{ secrets.EC2_USER }}/workmate"
        scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -r \
            Chatbot-backend-main/* \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:$REMOTE_BASE/Chatbot-backend-main/ || { echo "âŒ scp ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"; exit 1; }
        echo "âœ… scp ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†"

    - name: Test workflow and clean up
      run: |
        echo "ğŸš€ GitHub Actionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå‹•ä½œã—ã¦ã„ã¾ã™"
        echo "ğŸ“‚ ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å†…å®¹:"
        ls -la
        echo ""
        echo "ğŸ“ Chatbot-backend-mainãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª:"
        if [ -d "Chatbot-backend-main" ]; then
          echo "âœ… Chatbot-backend-mainãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã™"
          ls -la Chatbot-backend-main/
        else
          echo "âŒ Chatbot-backend-mainãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi
        
        echo "ğŸ§¹ ä¸è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ã—ã¦ãƒ‡ã‚£ã‚¹ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿..."
        # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤ã«ã¯ä¸è¦ï¼‰
        rm -rf Chatbot-Frontend-main/
        rm -rf src/
        rm -rf public/
        rm -rf scripts/
        rm -rf supabase/
        
        echo "æœ€çµ‚çš„ãªãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨çŠ¶æ³:"
        df -h

    # ------------- æ–°ã‚¹ãƒ†ãƒƒãƒ—: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼†å†èµ·å‹• -------------
    - name: Remote install & restart backend
      run: |
        echo "ğŸš€ ãƒªãƒ¢ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†èµ·å‹•é–‹å§‹..."
        REMOTE_BASE="/home/${{ secrets.EC2_USER }}/workmate"
        
        # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•ã‚’å®Ÿè¡Œ
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
          'set -eux; REMOTE_BASE="$HOME/workmate"; DEPLOY_PATH="$REMOTE_BASE/Chatbot-backend-main"; echo "DEBUG: REMOTE_BASE=$REMOTE_BASE"; echo "DEBUG: DEPLOY_PATH=$DEPLOY_PATH"; ls -la "$REMOTE_BASE" || true; ls -la "$DEPLOY_PATH" || true; cd "$DEPLOY_PATH"; if [ -d "$DEPLOY_PATH/venv" ]; then echo "æ—¢å­˜ã®venvç’°å¢ƒã‚’ä½¿ç”¨ã—ã¾ã™"; source "$DEPLOY_PATH/venv/bin/activate"; elif [ -f /opt/workmate-venv/bin/activate ]; then echo "/opt/workmate-venvç’°å¢ƒã‚’ä½¿ç”¨ã—ã¾ã™"; source /opt/workmate-venv/bin/activate; elif [ -f "$HOME/workmate-venv/bin/activate" ]; then echo "ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®venvç’°å¢ƒã‚’ä½¿ç”¨ã—ã¾ã™"; source "$HOME/workmate-venv/bin/activate"; else echo "æ–°ã—ã„venvç’°å¢ƒã‚’ä½œæˆã—ã¾ã™"; if [ -w /opt ]; then sudo python3 -m venv /opt/workmate-venv && source /opt/workmate-venv/bin/activate; else python3 -m venv "$HOME/workmate-venv" && source "$HOME/workmate-venv/bin/activate"; fi; fi; echo "[Deploy] pip install -r requirements.txt --upgrade --quiet"; pip install -r requirements.txt --upgrade --quiet; echo "[Deploy] restart workmate.service"; sudo systemctl restart workmate.service'
        
        echo "âœ… ãƒªãƒ¢ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†èµ·å‹•å®Œäº†"

    - name: Verify deployment
      run: |
        echo "ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼..."
        
        # ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
        echo "ğŸŒ ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª:"
        ssh -o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
          'ps aux | grep -E "(python|main\.py)" | grep -v grep || echo "Pythonãƒ—ãƒ­ã‚»ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"'
        
        # PM2ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
        echo "ğŸ”§ PM2ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª:"
        ssh -o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
          'if command -v pm2 >/dev/null 2>&1; then pm2 list; else echo "PM2ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; fi'
        
        # Webã‚µãƒ¼ãƒãƒ¼ç¢ºèª
        echo "ğŸš€ å®Ÿè¡Œä¸­ã®Webã‚µãƒ¼ãƒãƒ¼:"
        ssh -o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
          'netstat -tlnp | grep -E ":(8083|8000|3000)" || echo "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"'
        
        echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼å®Œäº†"