name: Deploy Backend

on:
  push:
    paths:
      - 'Chatbot-backend-main/**'
      - 'Chatbot-backend-master/**'
    branches:
      - main
      - master

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Debug connection info
      run: |
        echo "ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
        echo "EC2_HOST: ${{ secrets.EC2_HOST }}"
        echo "EC2_USER: ${{ secrets.EC2_USER }}"
        echo "EC2_PATH: ${{ secrets.EC2_PATH }}"
        echo ""
        echo "ğŸŒ ãƒ›ã‚¹ãƒˆæ¥ç¶šæ€§ãƒ†ã‚¹ãƒˆ:"
        ping -c 3 ${{ secrets.EC2_HOST }} || echo "âŒ ãƒ›ã‚¹ãƒˆã«pingãŒå±Šãã¾ã›ã‚“"

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        echo "ğŸ”‘ SSHéµã®ç¢ºèª:"
        ls -la ~/.ssh/id_rsa
        echo ""
        
        echo "ğŸ”— SSHæ¥ç¶šãƒ†ã‚¹ãƒˆ:"
        ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'SSHæ¥ç¶šæˆåŠŸ'" || {
          echo "âŒ SSHæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "ğŸ” ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨ºæ–­:"
          nmap -p 22 ${{ secrets.EC2_HOST }} || echo "nmapãŒåˆ©ç”¨ã§ãã¾ã›ã‚“"
          exit 1
        }
        
        echo "âœ… SSHæ¥ç¶šãŒæˆåŠŸã—ã¾ã—ãŸ"
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy backend
      run: |
        echo "ğŸ“¤ ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€é–‹å§‹..."
        echo "ğŸ” è»¢é€è©³ç´°:"
        echo "ã‚½ãƒ¼ã‚¹: Chatbot-backend-main"
        echo "å®›å…ˆ: ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ secrets.EC2_PATH }}/"
        
        echo "ğŸ”— æœ€çµ‚SSHæ¥ç¶šç¢ºèª:"
        ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'SSHæ¥ç¶šOK'" || {
          echo "âŒ SSHæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
        }
        
        echo "ğŸ“‚ è»¢é€å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
        ls -la Chatbot-backend-main/ | head -10
        echo "ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºçµ±è¨ˆ:"
        du -sh Chatbot-backend-main/
        find Chatbot-backend-main/ -type f -size +1M | head -5
        
        echo "ğŸ§¹ å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ä¸è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®é™¤å»:"
        # å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ5MBä»¥ä¸Šï¼‰ã‚’ãƒã‚§ãƒƒã‚¯
        echo "5MBä»¥ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«:"
        find Chatbot-backend-main/ -type f -size +5M || echo "å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ãªã—"
        
        # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã€ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
        find Chatbot-backend-main/ -name "*.log" -delete || true
        find Chatbot-backend-main/ -name "*.pid" -delete || true
        find Chatbot-backend-main/ -name "__pycache__" -type d -exec rm -rf {} + || true
        find Chatbot-backend-main/ -name "*.pyc" -delete || true
        find Chatbot-backend-main/ -name ".DS_Store" -delete || true
        find Chatbot-backend-main/ -name "nohup.out" -delete || true
        
        echo "ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œã®ã‚µã‚¤ã‚º:"
        du -sh Chatbot-backend-main/
        
        echo "ğŸš€ æœ€åˆã«tar.gzæ–¹å¼ã§è»¢é€ã‚’è©¦è¡Œ:"
        {
          echo "ğŸ“¦ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’taråœ§ç¸®:"
          tar -czf backend.tar.gz Chatbot-backend-main/
          ls -lh backend.tar.gz
          
          echo "ğŸš€ SSHçµŒç”±ã§tarè»¢é€ + å±•é–‹ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 600ç§’ï¼‰:"
          timeout 600 bash -c "cat backend.tar.gz | ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'cd ${{ secrets.EC2_PATH }} && rm -rf Chatbot-backend-main.bak && mv Chatbot-backend-main Chatbot-backend-main.bak 2>/dev/null || true && tar -xzf - && echo \"âœ… ãƒ•ã‚¡ã‚¤ãƒ«å±•é–‹å®Œäº†\"'"
          
          echo "âœ… tar.gzæ–¹å¼ã§ã®è»¢é€å®Œäº†"
          
        } || {
          echo "âŒ tar.gzè»¢é€ã«å¤±æ•—ã€rsyncã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯:"
          
          echo "ğŸ”„ rsyncè»¢é€ã‚’è©¦è¡Œï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 600ç§’ï¼‰:"
          timeout 600 rsync -avz -e "ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa" --progress --partial --inplace Chatbot-backend-main/ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ secrets.EC2_PATH }}/Chatbot-backend-main/ || {
            echo "âŒ rsyncè»¢é€ã‚‚å¤±æ•—ã€SCPæ–¹å¼ã‚’æœ€å¾Œã«è©¦è¡Œ:"
            
            echo "ğŸ”„ SCPåˆ†å‰²è»¢é€ï¼ˆå°ã•ãªãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ï¼‰:"
            # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãªã©é‡è¦ãªå°ã•ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆã«è»¢é€
            scp -o ConnectTimeout=30 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa Chatbot-backend-main/*.py Chatbot-backend-main/requirements.txt ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ secrets.EC2_PATH }}/Chatbot-backend-main/ || echo "å°ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€å¤±æ•—"
            
            # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ä½œæˆ
            ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "cd ${{ secrets.EC2_PATH }}/Chatbot-backend-main && mkdir -p modules static"
            
            # modulesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è»¢é€
            timeout 300 scp -o ConnectTimeout=30 -o StrictHostKeyChecking=no -r -i ~/.ssh/id_rsa Chatbot-backend-main/modules/ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ secrets.EC2_PATH }}/Chatbot-backend-main/ || echo "modulesè»¢é€å¤±æ•—"
            
            echo "âš ï¸ åˆ†å‰²è»¢é€å®Œäº†ï¼ˆä¸€éƒ¨å¤±æ•—ã®å¯èƒ½æ€§ï¼‰"
          }
        }
        
        echo "ğŸ” è»¢é€å¾Œç¢ºèª:"
        ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "ls -la ${{ secrets.EC2_PATH }}/Chatbot-backend-main/"
        
        echo "ğŸš€ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹..."
        ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          cd ${{ secrets.EC2_PATH }}/Chatbot-backend-main
          echo "ğŸ“‚ ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)"
          
          echo "ğŸ Pythonä»®æƒ³ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—..."
          python3 -m venv venv
          source venv/bin/activate
          
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«..."
          pip install -r requirements.txt
          
          echo "â¹ï¸ æ—¢å­˜ãƒ—ãƒ­ã‚»ã‚¹åœæ­¢..."
          pkill -f main.py || true
          sleep 2
          
          echo "â–¶ï¸ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰èµ·å‹•..."
          nohup python3 main.py > backend.log 2>&1 &
          echo $! > backend.pid
          
          echo "âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
          echo "ğŸ“Š ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª:"
          ps aux | grep main.py | grep -v grep || echo "ãƒ—ãƒ­ã‚»ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        EOF