name: Deploy Backend

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
    - name: Free up disk space
      run: |
        echo "ğŸ§¹ ãƒ‡ã‚£ã‚¹ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ã—ã¦ã„ã¾ã™..."
        echo "åˆæœŸã®ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨çŠ¶æ³:"
        df -h
        
        # ä¸è¦ãªãƒ„ãƒ¼ãƒ«ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/local/share/chromium
        sudo rm -rf /usr/share/swift
        
        # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        docker rmi $(docker image ls -q) || true
        
        # APTã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        sudo apt-get clean
        sudo apt-get autoremove -y
        
        echo "ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œã®ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨çŠ¶æ³:"
        df -h
        
    - name: Checkout
      uses: actions/checkout@v3

    - name: Test workflow and clean up
      run: |
        echo "ğŸš€ GitHub Actionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå‹•ä½œã—ã¦ã„ã¾ã™"
        echo "ğŸ“‚ ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å†…å®¹:"
        ls -la
        echo ""
        echo "ğŸ“ Chatbot-backend-mainãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª:"
        if [ -d "Chatbot-backend-main" ]; then
          echo "âœ… Chatbot-backend-mainãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã™"
          ls -la Chatbot-backend-main/
        else
          echo "âŒ Chatbot-backend-mainãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi
        
        echo "ğŸ§¹ ä¸è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ã—ã¦ãƒ‡ã‚£ã‚¹ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿..."
        # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤ã«ã¯ä¸è¦ï¼‰
        rm -rf Chatbot-Frontend-main/
        rm -rf src/
        rm -rf public/
        rm -rf scripts/
        rm -rf supabase/
        
        echo "æœ€çµ‚çš„ãªãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨çŠ¶æ³:"
        df -h

    - name: Setup SSH
      run: |
        echo "ğŸ”‘ SSHè¨­å®šé–‹å§‹..."
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
        
        echo "ğŸ”— SSHæ¥ç¶šãƒ†ã‚¹ãƒˆ:"
        ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'SSHæ¥ç¶šæˆåŠŸ'" || {
          echo "âŒ SSHæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
        }
        echo "âœ… SSHæ¥ç¶šãŒæˆåŠŸã—ã¾ã—ãŸ"

    - name: Prepare backend files
      run: |
        echo "ğŸ“¦ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™..."
        cd Chatbot-backend-main
        
        # GitHub Actionsç’°å¢ƒã§ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿ã®ãŸã‚ã€
        # ãƒ†ã‚¹ãƒˆé–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–
        rm -rf tests/
        rm -f requirements-test.txt
        rm -rf venv/
        rm -rf __pycache__/
        rm -f *.log
        
        # ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ã—ã¦ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ
        tar --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.env' \
            --exclude='node_modules' \
            --exclude='venv' \
            --exclude='*.log' \
            --exclude='dist' \
            --exclude='build' \
            --exclude='coverage' \
            --exclude='.pytest_cache' \
            --exclude='.coverage' \
            --exclude='tests' \
            --exclude='requirements-test.txt' \
            -czf ../backend.tar.gz .
        
        echo "ğŸ“¦ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å†…å®¹ç¢ºèª:"
        tar -tzf ../backend.tar.gz | head -20
        
        echo "âœ… ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™å®Œäº†"

    - name: Deploy backend
      run: |
        echo "ğŸ“¤ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€é–‹å§‹..."
        
        # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ã‚µãƒ¼ãƒãƒ¼ã«è»¢é€
        scp -o ConnectTimeout=30 -o ServerAliveInterval=10 backend.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/
        
        echo "ğŸš€ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ..."
        ssh -o ConnectTimeout=30 -o ServerAliveInterval=10 ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
          set -e
          
          # ãƒ‘ã‚¹è¨­å®š
          DEPLOY_PATH="${{ secrets.EC2_PATH }}"
          
          echo "ğŸ“‚ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ã‚¹: $DEPLOY_PATH"
          echo "ğŸ‘¤ ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: $(whoami)"
          echo "ğŸ“‚ ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)"
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæº–å‚™
          echo "ğŸ—‚ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæº–å‚™..."
          mkdir -p $DEPLOY_PATH
          cd $DEPLOY_PATH
          
          # ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ç¢ºèªã¨å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
          echo "ğŸ’¾ ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ç¢ºèª..."
          df -h $DEPLOY_PATH
          
          echo "ğŸ§¹ å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ï¼ˆãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ç¢ºä¿ï¼‰..."
          
          # ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ãŒ90%ä»¥ä¸Šã®å ´åˆã€å¼·åŠ›ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
          DISK_USAGE=$(df $DEPLOY_PATH | tail -1 | awk '{print $5}' | sed 's/%//')
          echo "ç¾åœ¨ã®ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡: ${DISK_USAGE}%"
          
          if [ "$DISK_USAGE" -gt 90 ]; then
            echo "âš ï¸ ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ãŒ90%ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚å¼·åŠ›ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¾ã™..."
            
            # å¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
            sudo find /var/log -name "*.log" -type f -mtime +7 -delete 2>/dev/null || true
            sudo find /var/log -name "*.log.*" -type f -mtime +3 -delete 2>/dev/null || true
            
            # PM2ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            if command -v pm2 >/dev/null 2>&1; then
              pm2 flush 2>/dev/null || true
            fi
            
            # tmpãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            sudo find /tmp -type f -mtime +1 -delete 2>/dev/null || true
            
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            rm -rf ~/.cache/* 2>/dev/null || true
            rm -rf ~/.npm/_cacache 2>/dev/null || true
            
            # Pythonã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            find $HOME -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
            find $HOME -name "*.pyc" -delete 2>/dev/null || true
            
            # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            if command -v dnf >/dev/null 2>&1; then
              sudo dnf clean all 2>/dev/null || true
            elif command -v yum >/dev/null 2>&1; then
              sudo yum clean all 2>/dev/null || true
            fi
            
            echo "ãƒ‡ã‚£ã‚¹ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿å¾Œã®å®¹é‡:"
            df -h $DEPLOY_PATH
          fi
          
          # .envãƒ•ã‚¡ã‚¤ãƒ«ä»¥å¤–ã®å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          find . -maxdepth 1 -type f ! -name '.env' ! -name '.env.*' -delete 2>/dev/null || true
          find . -maxdepth 1 -type d ! -name '.' ! -name 'venv' -exec rm -rf {} + 2>/dev/null || true
          
          # å¤ã„venvã‚‚å‰Šé™¤ã—ã¦ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã‚’ç¢ºä¿
          if [ "$DISK_USAGE" -gt 85 ]; then
            echo "ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ç¢ºä¿ã®ãŸã‚æ—¢å­˜ã®venvã‚’å‰Šé™¤ã—ã¾ã™..."
            rm -rf venv 2>/dev/null || true
          fi
          
          # æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å±•é–‹
          echo "ğŸ“¦ ãƒ•ã‚¡ã‚¤ãƒ«å±•é–‹..."
          tar -xzf /tmp/backend.tar.gz
          
          echo "âœ… ãƒ•ã‚¡ã‚¤ãƒ«å±•é–‹å®Œäº†"
          
          # Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          echo "ğŸ“¥ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«..."
          
          # Pythonç’°å¢ƒç¢ºèª
          echo "ğŸ Pythonç’°å¢ƒç¢ºèª..."
          python3 --version || echo "Python3ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          
          # pipã®ç¢ºèªãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          echo "ğŸ“¦ pipç¢ºèªãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«..."
          if ! command -v pip >/dev/null 2>&1 && ! command -v pip3 >/dev/null 2>&1 && ! python3 -m pip --version >/dev/null 2>&1; then
            echo "pipãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è©¦è¡Œã—ã¾ã™..."
            # Amazon Linux 2023ã®å ´åˆ
            if command -v dnf >/dev/null 2>&1; then
              echo "Amazon Linux 2023ã§pipã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
              sudo dnf install -y python3-pip python3-devel || echo "pipã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ"
            elif command -v yum >/dev/null 2>&1; then
              echo "YUMã§pipã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
              sudo yum install -y python3-pip python3-devel || echo "pipã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ"
            elif command -v apt >/dev/null 2>&1; then
              echo "APTã§pipã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
              sudo apt update && sudo apt install -y python3-pip python3-dev || echo "pipã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ"
            fi
          fi
          
          # PostgreSQLãŠã‚ˆã³é–‹ç™ºãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          echo "ğŸ˜ PostgreSQLé–‹ç™ºãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«..."
          if command -v dnf >/dev/null 2>&1; then
            echo "Amazon Linux 2023ã§é–‹ç™ºãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
            sudo dnf install -y postgresql15-devel gcc gcc-c++ libffi-devel openssl-devel || echo "é–‹ç™ºãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ"
          elif command -v yum >/dev/null 2>&1; then
            echo "YUMã§é–‹ç™ºãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
            sudo yum install -y postgresql-devel gcc gcc-c++ libffi-devel openssl-devel || echo "é–‹ç™ºãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ"
          elif command -v apt >/dev/null 2>&1; then
            echo "APTã§é–‹ç™ºãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
            sudo apt update && sudo apt install -y libpq-dev gcc g++ libffi-dev libssl-dev || echo "é–‹ç™ºãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ"
          fi
          
          # pipã‚³ãƒãƒ³ãƒ‰ã®æ±ºå®š
          PIP_CMD=""
          if command -v pip3 >/dev/null 2>&1; then
            PIP_CMD="pip3"
          elif command -v pip >/dev/null 2>&1; then
            PIP_CMD="pip"
          elif python3 -m pip --version >/dev/null 2>&1; then
            PIP_CMD="python3 -m pip"
          else
            echo "âš ï¸ pipã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ‰‹å‹•ã§ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¿…è¦ã§ã™ã€‚"
            PIP_CMD="python3 -m pip"
          fi
          
          echo "ä½¿ç”¨ã™ã‚‹pipã‚³ãƒãƒ³ãƒ‰: $PIP_CMD"
          
          if [ -f "requirements.txt" ]; then
            # ä»®æƒ³ç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            echo "ğŸ  ä»®æƒ³ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—..."
            if [ ! -d "venv" ]; then
              echo "æ–°ã—ã„ä»®æƒ³ç’°å¢ƒã‚’ä½œæˆã—ã¾ã™..."
              python3 -m venv venv
            else
              echo "æ—¢å­˜ã®ä»®æƒ³ç’°å¢ƒã‚’ä½¿ç”¨ã—ã¾ã™"
            fi
            
            # ä»®æƒ³ç’°å¢ƒã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆ
            source venv/bin/activate
            echo "ä»®æƒ³ç’°å¢ƒã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆã—ã¾ã—ãŸ: $(which python)"
            
            # requirements.txtã®å¤‰æ›´ãƒã‚§ãƒƒã‚¯ï¼ˆãƒãƒƒã‚·ãƒ¥ãƒ™ãƒ¼ã‚¹ï¼‰
            REQUIREMENTS_CHANGED=false
            CURRENT_HASH=$(md5sum requirements.txt 2>/dev/null | cut -d' ' -f1 || echo "new")
            STORED_HASH=$(cat .requirements_hash 2>/dev/null || echo "")
            
            if [ "$CURRENT_HASH" != "$STORED_HASH" ]; then
              echo "ğŸ“ requirements.txtã«å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
              REQUIREMENTS_CHANGED=true
            else
              echo "ğŸ“ requirements.txtã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
            fi
            
            # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆå¿…è¦ãªå ´åˆã®ã¿ï¼‰
            if [ "$REQUIREMENTS_CHANGED" = true ]; then
              echo "ğŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Ÿè¡Œ..."
              echo "â±ï¸ åˆå›ã¾ãŸã¯å¤‰æ›´ãŒã‚ã‚‹ãŸã‚ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ï¼ˆæ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰"
              
              # pipã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è¨­å®šã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
              export PIP_CACHE_DIR="$HOME/.cache/pip"
              echo "ğŸ§¹ pipã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—..."
              rm -rf $PIP_CACHE_DIR/*
              mkdir -p $PIP_CACHE_DIR
              echo "ğŸ’¾ pipã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $PIP_CACHE_DIR"
              
              # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚é–“è¨ˆæ¸¬é–‹å§‹
              INSTALL_START=$(date +%s)
              
              # pipã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¨ãƒ›ã‚¤ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
              $PIP_CMD install --upgrade pip setuptools wheel
              
              # å¤§ããªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å€‹åˆ¥ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ç¶šè¡Œï¼‰
              echo "ğŸ“¦ å¤§ããªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å€‹åˆ¥ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«..."
              
              # å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æœ€åˆã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
              $PIP_CMD install --no-cache-dir fastapi==0.109.2 uvicorn==0.27.1 python-multipart python-dotenv==1.0.1
              
              # Googleé–¢é€£ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
              $PIP_CMD install --no-cache-dir google-generativeai==0.3.2 google-api-python-client google-auth-httplib2 google-auth-oauthlib google-auth
              
              # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£
              $PIP_CMD install --no-cache-dir asyncpg==0.30.0 psycopg2-binary==2.9.10 supabase
              
              # ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†é–¢é€£ï¼ˆã‚µã‚¤ã‚ºãŒå¤§ãã„ã‚‚ã®ã¯å€‹åˆ¥ã«ï¼‰
              $PIP_CMD install --no-cache-dir PyPDF2==3.0.1 beautifulsoup4==4.12.2 aiofiles==24.1.0 requests==2.31.0
              
              # ç”»åƒå‡¦ç†é–¢é€£ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰
              $PIP_CMD install --no-cache-dir pillow || echo "âš ï¸ Pillowã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç¶šè¡Œï¼‰"
              $PIP_CMD install --no-cache-dir pymupdf==1.23.7 || echo "âš ï¸ PyMuPDFã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç¶šè¡Œï¼‰"
              $PIP_CMD install --no-cache-dir pdf2image==1.16.3 || echo "âš ï¸ pdf2imageã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç¶šè¡Œï¼‰"
              
              # AWSé–¢é€£
              $PIP_CMD install --no-cache-dir boto3==1.37.22 || echo "âš ï¸ boto3ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç¶šè¡Œï¼‰"
              
              # ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–ï¼‰
              $PIP_CMD install --no-cache-dir youtube_transcript_api || echo "âš ï¸ youtube_transcript_apiã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç¶šè¡Œï¼‰"
              $PIP_CMD install --no-cache-dir yt-dlp || echo "âš ï¸ yt-dlpã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç¶šè¡Œï¼‰"
              $PIP_CMD install --no-cache-dir tiktoken || echo "âš ï¸ tiktokenã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç¶šè¡Œï¼‰"
              
              # ãƒ‡ãƒ¼ã‚¿å‡¦ç†é–¢é€£ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰
              $PIP_CMD install --no-cache-dir pandas openpyxl xlrd python-docx || echo "âš ï¸ ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç¶šè¡Œï¼‰"
              
              # RAGé–¢é€£
              $PIP_CMD install --no-cache-dir bm25s scikit-learn numpy || echo "âš ï¸ RAGé–¢é€£ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç¶šè¡Œï¼‰"
              
              # aiohttp
              $PIP_CMD install --no-cache-dir aiohttp || echo "âš ï¸ aiohttpã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç¶šè¡Œï¼‰"
              
              # Playwrightã¯æœ€å¾Œã«ï¼ˆå¤§ãã„ãŸã‚ï¼‰
              $PIP_CMD install --no-cache-dir playwright || echo "âš ï¸ Playwrightã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç¶šè¡Œï¼‰"
              
              # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚é–“è¨ˆæ¸¬çµ‚äº†
              INSTALL_END=$(date +%s)
              INSTALL_TIME=$((INSTALL_END - INSTALL_START))
              echo "â±ï¸ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚é–“: ${INSTALL_TIME}ç§’"
              
              # requirements.txtã®ãƒãƒƒã‚·ãƒ¥ä¿å­˜
              echo "$CURRENT_HASH" > .requirements_hash
              echo "âœ… requirements.txtãƒãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ã—ã¾ã—ãŸ"
              
              # Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
              if $PIP_CMD show playwright >/dev/null 2>&1; then
                echo "ğŸŒ Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«..."
                python3 -m playwright install chromium || echo "Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ"
              fi
            else
              echo "âš¡ requirements.txtã«å¤‰æ›´ãŒãªã„ãŸã‚ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
              # pipã¨setuptoolsã®ã¿æ›´æ–°
              $PIP_CMD install --upgrade pip setuptools wheel --quiet
            fi
            
            echo "âœ… Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æº–å‚™å®Œäº†"
          else
            echo "âŒ requirements.txtãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
          
          # PM2ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•
          echo "ğŸ”„ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•..."
          if command -v pm2 >/dev/null 2>&1; then
            # PM2ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
            pm2 list
            
            # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åã‚’ç¢ºèªã—ã¦å†èµ·å‹•ï¼ˆå„ªå…ˆé †ä½ä»˜ãï¼‰
            if pm2 describe chatbot-backend >/dev/null 2>&1; then
              echo "chatbot-backend ã‚’å†èµ·å‹•ã—ã¾ã™..."
              pm2 restart chatbot-backend
            elif pm2 describe workmate-backend >/dev/null 2>&1; then
              echo "workmate-backend ã‚’å†èµ·å‹•ã—ã¾ã™..."
              pm2 restart workmate-backend
            elif pm2 describe app >/dev/null 2>&1; then
              echo "app ã‚’å†èµ·å‹•ã—ã¾ã™..."
              pm2 restart app
            else
              echo "æ–°ã—ã„PM2ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹å§‹ã—ã¾ã™..."
              pm2 start main.py --name chatbot-backend
            fi
            
            # PM2ãƒ—ãƒ­ã‚»ã‚¹çŠ¶æ…‹ç¢ºèª
            pm2 list
            pm2 save
          else
            echo "PM2ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç›´æ¥Pythonã§èµ·å‹•ã‚’è©¦è¡Œã—ã¾ã™..."
            nohup python main.py > app.log 2>&1 &
          fi
          
          echo "ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤çµæœç¢ºèª:"
          ls -la $DEPLOY_PATH/ | head -20
          
          echo "ğŸ§¹ ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤..."
          rm -f /tmp/backend.tar.gz
          
          echo "âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
        ENDSSH
        echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹å®Œäº†"

    - name: Verify deployment
      run: |
        echo "ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼..."
        ssh -o ConnectTimeout=15 ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
          echo 'ğŸŒ ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª:'
          ps aux | grep -E '(python|main\.py)' | grep -v grep || echo 'Pythonãƒ—ãƒ­ã‚»ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
          echo ''
          echo 'ğŸ”§ PM2ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª:'
          if command -v pm2 >/dev/null 2>&1; then
            pm2 list
          else
            echo 'PM2ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
          fi
          echo ''
          echo 'ğŸš€ å®Ÿè¡Œä¸­ã®Webã‚µãƒ¼ãƒãƒ¼:'
          netstat -tlnp | grep -E ':(8083|8000|3000)' || echo 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
        " || echo "âš ï¸ æ¤œè¨¼ã§ã„ãã¤ã‹ã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
        
        echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼å®Œäº†"