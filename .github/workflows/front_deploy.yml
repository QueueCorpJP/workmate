name: Deploy Frontend (SPA)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Build Frontend
      env:
        VITE_API_URL: https://workmatechat.com/chatbot/api
      run: |
        echo "ğŸ—ï¸ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰é–‹å§‹..."
        cd Chatbot-Frontend-main
        
        # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        npm ci --audit-level=high
        
        # ç’°å¢ƒå¤‰æ•°ç¢ºèª
        echo "VITE_API_URL: $VITE_API_URL"
        
        # ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
        npm run build
        
        echo "ğŸ“¦ ãƒ“ãƒ«ãƒ‰å†…å®¹ç¢ºèª:"
        ls -la dist/
        
        echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"

    - name: Deploy to EC2
      env:
        HOST: ${{ secrets.EC2_HOST }}
        USER: ${{ secrets.EC2_USER }}
        KEY: ${{ secrets.EC2_KEY }}
      run: |
        echo "ğŸ”‘ SSHéµè¨­å®š..."
        echo "$KEY" > id_rsa && chmod 600 id_rsa
        
        echo "ğŸ“¤ é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’EC2ã«åŒæœŸ..."
        # ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰sudoã§ç§»å‹•
        rsync -avz --delete -e "ssh -i id_rsa -o StrictHostKeyChecking=no" \
          Chatbot-Frontend-main/dist/ $USER@$HOST:/tmp/webapp_dist/
        
        echo "ğŸ”„ ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™è¨­å®šã¨Nginxå†èµ·å‹•..."
        ssh -i id_rsa -o StrictHostKeyChecking=no $USER@$HOST << 'ENDSSH'
          # ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰æœ¬ç•ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
          sudo rm -rf /var/www/html/*
          sudo cp -r /tmp/webapp_dist/* /var/www/html/
          sudo rm -rf /tmp/webapp_dist
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™è¨­å®š
          sudo chown -R nginx:nginx /var/www/html/ || sudo chown -R www-data:www-data /var/www/html/
          sudo chmod -R 755 /var/www/html/
          
          # Let's Encryptç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™ç¢ºä¿
          sudo mkdir -p /var/www/html/.well-known/acme-challenge
          sudo chown -R nginx:nginx /var/www/html/.well-known || sudo chown -R www-data:www-data /var/www/html/.well-known
          
          # Nginxè¨­å®šãƒ†ã‚¹ãƒˆã¨å†èµ·å‹•
          sudo nginx -t && sudo systemctl reload nginx
          
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
        ENDSSH
        
        rm -f id_rsa

    - name: Verify deployment
      env:
        HOST: ${{ secrets.EC2_HOST }}
        USER: ${{ secrets.EC2_USER }}
        KEY: ${{ secrets.EC2_KEY }}
      run: |
        echo "ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼..."
        echo "$KEY" > id_rsa && chmod 600 id_rsa
        
        ssh -i id_rsa -o StrictHostKeyChecking=no $USER@$HOST "
          echo 'ğŸ“ é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:'
          ls -la /var/www/html/index.html || echo 'âš ï¸ index.htmlãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
          echo 'ğŸŒ NginxçŠ¶æ…‹ç¢ºèª:'
          sudo nginx -t || echo 'âš ï¸ Nginxè¨­å®šã‚¨ãƒ©ãƒ¼'
        "
        
        rm -f id_rsa
        echo "âœ… æ¤œè¨¼å®Œäº†"