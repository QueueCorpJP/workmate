name: Deploy Frontend (SPA)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Build Frontend
      env:
        VITE_API_URL: https://workmatechat.com/chatbot/api
       
      run: |
        echo "ğŸ—ï¸ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰é–‹å§‹..."
        cd Chatbot-Frontend-main
        
        # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        npm ci --audit-level=high
        
        # ç’°å¢ƒå¤‰æ•°ç¢ºèª
        echo "VITE_API_URL: $VITE_API_URL"
        
        # ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
        npm run build
        
        echo "ğŸ“¦ ãƒ“ãƒ«ãƒ‰å†…å®¹ç¢ºèª:"
        ls -la dist/
        
        echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"

    - name: Deploy to EC2
      env:
        HOST: ${{ secrets.EC2_HOST }}
        USER: ${{ secrets.EC2_USER }}
        KEY: ${{ secrets.EC2_KEY }}
      run: |
        echo "ğŸ”‘ SSHéµè¨­å®š..."
        echo "$KEY" > id_rsa && chmod 600 id_rsa
        
        echo "ğŸ“¤ é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’EC2ã«åŒæœŸ..."
        BUILD_DIR="Chatbot-Frontend-main/dist/"
        TMP_REMOTE="/tmp/webapp_dist"

        rsync -az --delete -e "ssh -i id_rsa -o StrictHostKeyChecking=no" \
          "$BUILD_DIR" $USER@$HOST:"$TMP_REMOTE" || { echo "âŒ rsync å¤±æ•—"; exit 1; }

        echo "ğŸ”„ ã‚¢ãƒˆãƒŸãƒƒã‚¯åˆ‡æ›¿ã¨Nginxå†èµ·å‹•..."
        ssh -i id_rsa -o StrictHostKeyChecking=no $USER@$HOST << 'ENDSSH'
          set -eux
          TMP_REMOTE="/tmp/webapp_dist"
          WEB_ROOT="/var/www/html"
          DEPLOY_DIR="/var/www/html_$(date +%Y%m%d%H%M%S)"

          # é…ç½®å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç”¨æ„ã—ã‚³ãƒ”ãƒ¼
          sudo mkdir -p "${DEPLOY_DIR}"
          sudo cp -r "${TMP_REMOTE}"/* "${DEPLOY_DIR}/"

          # é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ãƒã‚§ãƒƒã‚¯
          if ! sudo ls "${DEPLOY_DIR}/static/js/sharedDataService-"*".js" > /dev/null 2>&1; then
            echo "âŒ å¿…é ˆãƒãƒ£ãƒ³ã‚¯(sharedDataService)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™";
            exit 1;
          fi

          # æ—§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ãªãŒã‚‰ã‚¢ãƒˆãƒŸãƒƒã‚¯ã«åˆ‡æ›¿ãˆ
          sudo mv "${WEB_ROOT}" "${WEB_ROOT}_backup_$(date +%s)" || true
          sudo mv "${DEPLOY_DIR}" "${WEB_ROOT}"

          # ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤
          sudo rm -rf ${TMP_REMOTE}

          # å¤ã„ãƒªãƒªãƒ¼ã‚¹ã‚’æœ€å¤§3ä¸–ä»£æ®‹ã—ã¦æƒé™¤
          sudo ls -dt /var/www/html_* | tail -n +4 | xargs -r sudo rm -rf || true

          # æ¨©é™è¨­å®š
          sudo chown -R nginx:nginx "${DEPLOY_DIR}" || sudo chown -R www-data:www-data "${DEPLOY_DIR}"
          sudo chmod -R 755 "${DEPLOY_DIR}"

          # Nginxãƒªãƒ­ãƒ¼ãƒ‰
          sudo nginx -t && sudo systemctl reload nginx
           
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
        ENDSSH
        
        rm -f id_rsa

    - name: Verify deployment
      env:
        HOST: ${{ secrets.EC2_HOST }}
        USER: ${{ secrets.EC2_USER }}
        KEY: ${{ secrets.EC2_KEY }}
      run: |
        echo "ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼..."
        echo "$KEY" > id_rsa && chmod 600 id_rsa
        
        ssh -i id_rsa -o StrictHostKeyChecking=no $USER@$HOST "
          echo 'ğŸ“ é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:'
          ls -la /var/www/html/index.html || echo 'âš ï¸ index.htmlãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
          echo 'ğŸŒ NginxçŠ¶æ…‹ç¢ºèª:'
          sudo nginx -t || echo 'âš ï¸ Nginxè¨­å®šã‚¨ãƒ©ãƒ¼'
        "
        
        rm -f id_rsa
        echo "âœ… æ¤œè¨¼å®Œäº†"