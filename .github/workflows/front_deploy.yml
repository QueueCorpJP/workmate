name: Deploy SSR Frontend

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Build SSR Frontend
      run: |
        echo "ğŸ—ï¸ SSRç”¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰é–‹å§‹..."
        cd Chatbot-Frontend-main
        
        # æœ¬ç•ªç”¨ç’°å¢ƒå¤‰æ•°ã§ãƒ“ãƒ«ãƒ‰
        npm ci
        cross-env VITE_API_URL=https://workmatechat.com/chatbot/api npm run build
        
        echo "ğŸ“¦ ãƒ“ãƒ«ãƒ‰å†…å®¹ç¢ºèª:"
        ls -la dist/
        
        echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"

    - name: Deploy to EC2 via rsync
      env:
        HOST: ${{ secrets.EC2_HOST }}
        USER: ${{ secrets.EC2_USER }}
        KEY: ${{ secrets.EC2_KEY }}
        DEPLOY_PATH: ${{ secrets.EC2_PATH }}
      run: |
        echo "ğŸ”‘ SSHéµè¨­å®š..."
        echo "$KEY" > id_rsa && chmod 600 id_rsa
        
        echo "ğŸ“¤ ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’EC2ã«åŒæœŸ..."
        # dist/ ãƒ•ã‚©ãƒ«ãƒ€ã‚’ /home/ec2-user/app/ ã«åŒæœŸï¼ˆå·®åˆ†è»¢é€ï¼‰
        rsync -avz --delete -e "ssh -i id_rsa -o StrictHostKeyChecking=no" \
          Chatbot-Frontend-main/dist/ $USER@$HOST:$DEPLOY_PATH/frontend/

    - name: Setup and Restart PM2
      env:
        HOST: ${{ secrets.EC2_HOST }}
        USER: ${{ secrets.EC2_USER }}
        KEY: ${{ secrets.EC2_KEY }}
        DEPLOY_PATH: ${{ secrets.EC2_PATH }}
      run: |
        echo "ğŸ”„ Node.js Express ã‚µãƒ¼ãƒãƒ¼è¨­å®šãƒ»å†èµ·å‹•..."
        ssh -i id_rsa -o StrictHostKeyChecking=no $USER@$HOST << 'ENDSSH'
          set -e
          
          DEPLOY_PATH="${{ secrets.EC2_PATH }}"
          FRONTEND_PATH="$DEPLOY_PATH/frontend"
          
          echo "ğŸ“‚ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é…ä¿¡ç”¨Express ã‚µãƒ¼ãƒãƒ¼è¨­å®š..."
          
          # Express ã‚µãƒ¼ãƒãƒ¼ç”¨ã®package.jsonã‚’ä½œæˆ
          cat > $FRONTEND_PATH/package.json << 'EOF'
{
  "name": "chatbot-frontend-server",
  "version": "1.0.0",
  "main": "server.js",
  "scripts": {
    "start": "node server.js"
  },
  "dependencies": {
    "express": "^4.18.2"
  }
}
EOF

          # Express ã‚µãƒ¼ãƒãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          cat > $FRONTEND_PATH/server.js << 'EOF'
const express = require('express');
const path = require('path');
const app = express();
const port = process.env.PORT || 3000;

// é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®é…ä¿¡
app.use(express.static(path.join(__dirname)));

// SPAç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå…¨ã¦ã®ãƒ«ãƒ¼ãƒˆã§index.htmlã‚’è¿”ã™ï¼‰
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'index.html'));
});

app.listen(port, () => {
  console.log(`ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ãŒãƒãƒ¼ãƒˆ ${port} ã§èµ·å‹•ã—ã¾ã—ãŸ`);
});
EOF

          echo "ğŸ“¦ Node.jsä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«..."
          cd $FRONTEND_PATH
          
          # npmãŒãªã„å ´åˆã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          if ! command -v npm >/dev/null 2>&1; then
            echo "npmã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
            curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
            sudo yum install -y nodejs npm
          fi
          
          npm install express

          echo "ğŸ”„ PM2ã§ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†..."
          
          # PM2ãŒãªã„å ´åˆã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          if ! command -v pm2 >/dev/null 2>&1; then
            echo "PM2ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
            sudo npm install -g pm2
          fi

          # æ—¢å­˜ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢ãƒ»å‰Šé™¤
          pm2 delete chatbot-frontend 2>/dev/null || echo "æ—¢å­˜ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          
          # æ–°ã—ã„ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹å§‹
          pm2 start server.js --name chatbot-frontend --port 3000
          pm2 save
          
          echo "ğŸ“Š PM2ãƒ—ãƒ­ã‚»ã‚¹çŠ¶æ³:"
          pm2 list
          
          echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»å†èµ·å‹•å®Œäº†"
        ENDSSH
        
        echo "ğŸ§¹ ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤..."
        rm -f id_rsa

    - name: Verify deployment
      env:
        HOST: ${{ secrets.EC2_HOST }}
        USER: ${{ secrets.EC2_USER }}
        KEY: ${{ secrets.EC2_KEY }}
      run: |
        echo "ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼..."
        echo "$KEY" > id_rsa && chmod 600 id_rsa
        
        ssh -i id_rsa -o StrictHostKeyChecking=no $USER@$HOST "
          echo 'ğŸŒ PM2ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª:'
          pm2 describe chatbot-frontend || echo 'âš ï¸ chatbot-frontendãƒ—ãƒ­ã‚»ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
          echo ''
          echo 'ğŸ”Œ ãƒãƒ¼ãƒˆ3000ç¢ºèª:'
          netstat -tlnp | grep ':3000' || echo 'âš ï¸ ãƒãƒ¼ãƒˆ3000ã§å¾…æ©Ÿä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
          echo ''
          echo 'ğŸ“ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:'
          ls -la ${{ secrets.EC2_PATH }}/frontend/index.html 2>/dev/null || echo 'âš ï¸ index.htmlãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
        " || echo "âš ï¸ æ¤œè¨¼ã§å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
        
        rm -f id_rsa
        echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼å®Œäº†"