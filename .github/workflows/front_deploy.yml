name: Deploy Frontend

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Test workflow
      run: |
        echo "ğŸš€ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰GitHub Actionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå‹•ä½œã—ã¦ã„ã¾ã™"
        echo "ğŸ“‚ ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å†…å®¹:"
        ls -la
        echo ""
        echo "ğŸ“ Chatbot-Frontend-mainãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª:"
        if [ -d "Chatbot-Frontend-main" ]; then
          echo "âœ… Chatbot-Frontend-mainãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã™"
          ls -la Chatbot-Frontend-main/ | head -10
        else
          echo "âŒ Chatbot-Frontend-mainãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
        
        echo "ğŸ”— SSHæ¥ç¶šãƒ†ã‚¹ãƒˆ:"
        ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'SSHæ¥ç¶šæˆåŠŸ'" || {
          echo "âŒ SSHæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
        }
        echo "âœ… SSHæ¥ç¶šãŒæˆåŠŸã—ã¾ã—ãŸ"

    - name: Build frontend
      run: |
        echo "ğŸ—ï¸ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰é–‹å§‹..."
        cd Chatbot-Frontend-main
        npm install
        npm run build
        
        echo "ğŸ“¦ ãƒ“ãƒ«ãƒ‰å†…å®¹ç¢ºèª:"
        ls -la dist/
        
        echo "ğŸ“¦ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ..."
        # GitHubãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ç›´ä¸‹ã«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½œæˆ
        tar -czf $GITHUB_WORKSPACE/frontend.tar.gz -C dist .
        
        echo "ğŸ“¦ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å†…å®¹ç¢ºèª:"
        tar -tzf $GITHUB_WORKSPACE/frontend.tar.gz | head -10
        
        echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"

    - name: Deploy frontend
      run: |
        echo "ğŸ“¤ ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€é–‹å§‹..."
        # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ç›´ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è»¢é€
        scp -o ConnectTimeout=30 -o ServerAliveInterval=10 $GITHUB_WORKSPACE/frontend.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/
        
        echo "ğŸš€ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹..."
        ssh -o ConnectTimeout=30 -o ServerAliveInterval=10 ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
          set -e
          
          # ãƒ‘ã‚¹è¨­å®š
          DEPLOY_PATH="${{ secrets.EC2_PATH }}"
          
          # Nginxã®rootãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºèªãƒ»è¨­å®š
          echo "ğŸ” Nginxè¨­å®šç¢ºèª..."
          NGINX_ROOT=""
          if command -v nginx >/dev/null 2>&1; then
            # Nginxè¨­å®šã‹ã‚‰rootãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—
            if [ -f /etc/nginx/sites-enabled/default ]; then
              NGINX_ROOT=$(grep -E "^\s*root\s+" /etc/nginx/sites-enabled/default | head -1 | awk '{print $2}' | sed 's/;//')
            elif [ -f /etc/nginx/nginx.conf ]; then
              NGINX_ROOT=$(grep -E "^\s*root\s+" /etc/nginx/nginx.conf | head -1 | awk '{print $2}' | sed 's/;//')
            fi
            
            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ã‚’è¨­å®š
            if [ -z "$NGINX_ROOT" ]; then
              if [ -d "/usr/share/nginx/html" ]; then
                NGINX_ROOT="/usr/share/nginx/html"
              else
                NGINX_ROOT="/var/www/html"
              fi
            fi
          else
            NGINX_ROOT="/var/www/html"
          fi
          
          echo "ğŸ“‚ ãƒ‘ã‚¹æƒ…å ±:"
          echo "DEPLOY_PATH: $DEPLOY_PATH"
          echo "NGINX_ROOT: $NGINX_ROOT"
          echo "ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)"
          
          echo "ğŸ—‚ï¸ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæº–å‚™..."
          sudo mkdir -p $NGINX_ROOT
          sudo chown $USER:$USER $NGINX_ROOT
          
          echo "ğŸ§¹ æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—..."
          sudo rm -rf $NGINX_ROOT/*
          
          echo "ğŸ“¦ ãƒ•ã‚¡ã‚¤ãƒ«å±•é–‹..."
          cd $NGINX_ROOT
          tar -xzf /tmp/frontend.tar.gz
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã®é©åˆ‡ãªè¨­å®š
          sudo chown -R nginx:nginx $NGINX_ROOT 2>/dev/null || sudo chown -R $USER:$USER $NGINX_ROOT
          sudo chmod -R 755 $NGINX_ROOT
          
          echo "ğŸ“Š é…ç½®ç¢ºèª:"
          ls -la $NGINX_ROOT/ | head -20
          
          echo "ğŸ”— ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯è¨­å®š..."
          if [ -d "$DEPLOY_PATH" ]; then
            # æ—¢å­˜ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’å‰Šé™¤
            if [ -L "$DEPLOY_PATH/static" ]; then
              rm -f "$DEPLOY_PATH/static"
            fi
            # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
            ln -sf $NGINX_ROOT "$DEPLOY_PATH/static"
            echo "ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸ: $DEPLOY_PATH/static -> $NGINX_ROOT"
          fi
          
          echo "ğŸŒ Nginxè¨­å®šãƒªãƒ­ãƒ¼ãƒ‰..."
          if command -v nginx >/dev/null 2>&1; then
            echo "NginxãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚è¨­å®šã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™..."
            sudo nginx -t && sudo systemctl reload nginx || echo "âš ï¸ Nginxè¨­å®šã®å•é¡ŒãŒã‚ã‚Šã¾ã™"
          else
            echo "âš ï¸ NginxãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
          
          # PM2ã§Node.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã¯å†èµ·å‹•
          echo "ğŸ”„ Node.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèªãƒ»å†èµ·å‹•..."
          if command -v pm2 >/dev/null 2>&1; then
            echo "PM2ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚Node.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¾ã™..."
            
            # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–¢é€£ã®PM2ãƒ—ãƒ­ã‚»ã‚¹ãŒã‚ã‚Œã°å†èµ·å‹•
            if pm2 describe workmate-frontend >/dev/null 2>&1; then
              echo "workmate-frontend ã‚’å†èµ·å‹•ã—ã¾ã™..."
              pm2 restart workmate-frontend
            elif pm2 describe frontend >/dev/null 2>&1; then
              echo "frontend ã‚’å†èµ·å‹•ã—ã¾ã™..."
              pm2 restart frontend
            else
              echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨ã®PM2ãƒ—ãƒ­ã‚»ã‚¹ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆé™çš„é…ä¿¡ã®å ´åˆã¯æ­£å¸¸ï¼‰"
            fi
            
            # ç¾åœ¨ã®PM2ãƒ—ãƒ­ã‚»ã‚¹ä¸€è¦§ã‚’è¡¨ç¤º
            pm2 list
          else
            echo "PM2ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆé™çš„é…ä¿¡ã®å ´åˆã¯æ­£å¸¸ï¼‰"
          fi
          
          echo "ğŸ§¹ ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤..."
          rm -f /tmp/frontend.tar.gz
          
          echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
          echo "ğŸ“Š æœ€çµ‚ç¢ºèª:"
          echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $(find $NGINX_ROOT -type f | wc -l)"
          echo "ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«:"
          ls -la $NGINX_ROOT/index.html $NGINX_ROOT/assets/ 2>/dev/null || echo "ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        ENDSSH
        
        echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹å®Œäº†"

    - name: Clear cache and verify
      run: |
        echo "ğŸ§¹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã¨æ¤œè¨¼..."
        ssh -o ConnectTimeout=15 ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
          echo 'ğŸŒ Webã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª:'
          netstat -tlnp | grep -E ':(80|443|3000)' || echo 'Webã‚µãƒ¼ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
          echo ''
          echo 'ğŸ“ é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:'
          if [ -f '/usr/share/nginx/html/index.html' ]; then
            echo 'Nginxæ¨™æº–ãƒ‘ã‚¹ (/usr/share/nginx/html) ã«index.htmlãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ'
          elif [ -f '/var/www/html/index.html' ]; then
            echo 'Apacheæ¨™æº–ãƒ‘ã‚¹ (/var/www/html) ã«index.htmlãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ'
          else
            echo 'âš ï¸ index.htmlãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
          fi
          echo ''
          echo 'ğŸ”§ Nginxè¨­å®šãƒ†ã‚¹ãƒˆ:'
          if command -v nginx >/dev/null 2>&1; then
            nginx -t || echo 'âš ï¸ Nginxè¨­å®šã«ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™'
          else
            echo 'NginxãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
          fi
        " || echo "âš ï¸ æ¤œè¨¼ã§ã„ãã¤ã‹ã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
        
        echo "ğŸ’¡ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢æ¨å¥¨äº‹é …:"
        echo "- ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãã ã•ã„ï¼ˆCtrl+F5 ã¾ãŸã¯ Cmd+Shift+Rï¼‰"
        echo "- CloudFrontã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€Invalidationã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
        
        echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼å®Œäº†"