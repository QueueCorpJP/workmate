# 変更履歴

## 2024/12/XX - 分析機能強化 & 環境別ポート設定改善

### 📊 分析機能の大幅改善
- `Chatbot-backend-main/modules/analytics.py` - Gemini分析強化（データ取得500→2000件、6項目明確化、具体的数値要求プロンプト）

### 🌐 環境別ポート設定の統一
- `Chatbot-backend-main/modules/config.py` - 環境検出機能追加、ローカル8085/本番8083自動切り替え、CORS環境別対応
- `Chatbot-backend-main/main.py` - CORS設定環境別適用、例外ハンドラー修正
- `Chatbot-Frontend-main/src/api.ts` - 環境判定強化、ローカル8085/本番8083自動切り替え
- `Chatbot-Frontend-main/vite.config.ts` - プロキシ設定ローカル8085対応

## 2024年最新修正：料金設定20倍変更

### 変更概要
ユーザーの要求により、トークン料金を20倍に変更しました。

### 変更内容

**変更前:**
- Input: $0.30 per 1M tokens
- Output: $2.5 per 1M tokens

**変更後（20倍）:**
- Input: $6.00 per 1M tokens
- Output: $50.00 per 1M tokens

### 修正ファイル
1. `Chatbot-backend-main/modules/token_counter.py`
   - workmate-standard, gemini-pro, gemini-1.5-proの料金設定を20倍に変更
   - input: 0.0003 → 0.006 (per 1K tokens)
   - output: 0.0025 → 0.05 (per 1K tokens)

2. `Chatbot-Frontend-main/src/components/BillingTab.tsx`
   - 料金表示テーブルの日本円表記を20倍に変更
   - Input: ¥0.045 → ¥0.90 /1,000tokens
   - Output: ¥0.375 → ¥7.50 /1,000tokens
   - 新料金体系の説明文を更新: "Input $6.00、Output $50.0 per 1M tokens"

3. `Chatbot-backend-main/update_token_schema.py`
   - 料金設定表示を20倍に更新
   - Input: $0.30 → $6.00 per 1M tokens
   - Output: $2.50 → $50.00 per 1M tokens

### 技術的詳細
- バックエンドの実際の計算ロジック（token_counter.py）を更新
- フロントエンドの表示用UI（BillingTab.tsx）を更新
- スキーマ更新スクリプト（update_token_schema.py）の表示メッセージを更新
- すべての料金計算が自動的に新しい価格で実行されます

---

## 2024年最新修正：環境別ポート設定の完全統一

### 変更概要
ローカル8085、本番8083で環境別ポート設定を完全に統一しました。

### 最終的な設定
- **ローカル環境**: 8085ポート（自動判定）
- **本番環境**: 8083ポート（自動判定）

### 修正ファイル
1. **ドキュメント修正**
   - `README.md` - ローカル例を8085に統一
   - `Chatbot-backend-main/README.md` - 環境別説明追加
   - `Chatbot-Frontend-main/README.md` - プロキシ設定8085に修正

2. **環境判定ロジック**
   - `Chatbot-backend-main/modules/config.py` - 環境別ポート自動切り替え
   - `Chatbot-Frontend-main/src/api.ts` - 環境別API URL自動生成

3. **本番環境設定（8083）**
   - `ecosystem.config.js` - PM2設定
   - `vercel.json` - Vercelプロキシ
   - `nginx/conf.d/workmatechat.com.conf` - Nginxプロキシ
   - `.htaccess` - Apacheプロキシ

### 技術的詳細
- 環境判定は NODE_ENV、ENVIRONMENT、DYNO、AWS_REGION 等を使用
- ローカル開発では自動的に8085を使用
- 本番デプロイでは自動的に8083を使用
- 手動PORT環境変数設定時は優先される

---
## 2024年最新修正：本番環境ビルドの堅牢化

### 問題
本番環境で8085ポートが参照されるエラーが報告された。原因は、本番環境のビルド時に意図しない開発用の環境変数が参照され、APIエンドポイントがローカル用になってしまうためと推定。

### 解決策
`Chatbot-Frontend-main/src/api.ts`のロジックを修正。本番環境（`NODE_ENV === 'production'`など）でビルドされる際は、環境変数（`VITE_API_URL`など）を完全に無視し、常に固定の本番URL（`https://workmatechat.com/chatbot/api`）を使用するように変更。これにより、環境変数の設定ミスに起因するエラーを未然に防ぐ。
