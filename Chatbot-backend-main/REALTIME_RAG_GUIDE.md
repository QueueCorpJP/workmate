# ğŸš€ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ RAGå‡¦ç†ãƒ•ãƒ­ãƒ¼å®Ÿè£…ã‚¬ã‚¤ãƒ‰

## æ¦‚è¦

æ–°ã—ã„ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ RAGï¼ˆRetrieval-Augmented Generationï¼‰å‡¦ç†ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«å¯¾ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æœ€é©ãªå›ç­”ã‚’ç”Ÿæˆã™ã‚‹5ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

## âœ… å®Ÿè£…ã•ã‚ŒãŸRAGãƒ•ãƒ­ãƒ¼

### Step 1. è³ªå•å…¥åŠ› âœï¸
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã«è³ªå•ã‚’å…¥åŠ›
- ä¾‹ï¼šã€Œè¿”å“ã—ãŸã„ã¨ãã¯ã©ã“ã«é€£çµ¡ã™ã‚Œã°ã„ã„ã§ã™ã‹ï¼Ÿã€

### Step 2. embedding ç”Ÿæˆ ğŸ§ 
- **Gemini Vectors APIï¼ˆgemini-embedding-exp-03-07ï¼‰** ã‚’ä½¿ç”¨
- è³ªå•æ–‡ã‚’ **3072æ¬¡å…ƒã®ãƒ™ã‚¯ãƒˆãƒ«** ã«å¤‰æ›
- é«˜ç²¾åº¦ãªæ„å‘³ç†è§£ã‚’å®Ÿç¾

### Step 3. é¡ä¼¼ãƒãƒ£ãƒ³ã‚¯æ¤œç´¢ï¼ˆTop-Kï¼‰ ğŸ”
- **Supabaseã® chunks ãƒ†ãƒ¼ãƒ–ãƒ«** ã‹ã‚‰æ¤œç´¢
- **pgvector** ã‚’ä½¿ç”¨ã—ãŸãƒ™ã‚¯ãƒˆãƒ«è·é›¢è¨ˆç®—
- SQLä¾‹ï¼š
```sql
SELECT * FROM chunks
ORDER BY embedding <#> '[è³ªå•ã®ãƒ™ã‚¯ãƒˆãƒ«]'
LIMIT 10;
```

### Step 4. LLMã¸é€ä¿¡ ğŸ’¡
- Top-K ãƒãƒ£ãƒ³ã‚¯ã¨å…ƒã®è³ªå•ã‚’ **Gemini Flash 2.5** ã«é€ä¿¡
- **è¦ç´„ã›ãšã«ã€ŒåŸæ–‡ãƒ™ãƒ¼ã‚¹ã€** ã§å›ç­”ã‚’ç”Ÿæˆ
- æ­£ç¢ºæ€§ã‚’æœ€å„ªå…ˆ

### Step 5. å›ç­”è¡¨ç¤º âš¡ï¸
- æœ€çµ‚çš„ãªå›ç­”ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤º
- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆé¡ä¼¼åº¦ã€ä½¿ç”¨ãƒãƒ£ãƒ³ã‚¯æ•°ç­‰ï¼‰ã‚‚å«ã‚€

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

### æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«

1. **`modules/realtime_rag.py`** - ãƒ¡ã‚¤ãƒ³ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ RAGå‡¦ç†ã‚·ã‚¹ãƒ†ãƒ 
2. **`modules/chat_realtime_rag.py`** - ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã¨ã®çµ±åˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
3. **`test_realtime_rag.py`** - ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
4. **`REALTIME_RAG_GUIDE.md`** - ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«

1. **`modules/chat.py`** - æ—¢å­˜ãƒãƒ£ãƒƒãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ RAGçµ±åˆ

## ğŸ”§ æŠ€è¡“ä»•æ§˜

### ä½¿ç”¨æŠ€è¡“
- **Gemini Embedding API**: `gemini-embedding-exp-03-07` (3072æ¬¡å…ƒ)
- **Gemini Chat API**: `gemini-2.5-flash`
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: Supabase PostgreSQL + pgvector
- **è¨€èª**: Python 3.8+

### ä¾å­˜é–¢ä¿‚
```python
google-generativeai
psycopg2-binary
supabase
python-dotenv
fastapi
```

### ç’°å¢ƒå¤‰æ•°
```bash
GOOGLE_API_KEY=your_gemini_api_key
SUPABASE_URL=your_supabase_url
SUPABASE_KEY=your_supabase_key
DB_PASSWORD=your_db_password
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åŸºæœ¬çš„ãªä½¿ç”¨æ–¹æ³•

```python
from modules.realtime_rag import process_question_realtime

# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ RAGå‡¦ç†ã‚’å®Ÿè¡Œ
result = await process_question_realtime(
    question="è¿”å“ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„",
    company_id="company_123",
    company_name="ã‚µãƒ³ãƒ—ãƒ«ä¼šç¤¾",
    top_k=10
)

print(f"å›ç­”: {result['answer']}")
print(f"ä½¿ç”¨ãƒãƒ£ãƒ³ã‚¯æ•°: {result['chunks_used']}")
print(f"æœ€é«˜é¡ä¼¼åº¦: {result['top_similarity']}")
```

### 2. ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã§ã®ä½¿ç”¨

```python
from modules.chat_realtime_rag import process_chat_with_realtime_rag

# ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†
response = await process_chat_with_realtime_rag(message, db, current_user)
```

### 3. ã‚¹ãƒ†ãƒƒãƒ—åˆ¥å®Ÿè¡Œ

```python
from modules.realtime_rag import get_realtime_rag_processor

processor = get_realtime_rag_processor()

# Step 1: è³ªå•å…¥åŠ›
step1_result = await processor.step1_receive_question("è³ªå•å†…å®¹")

# Step 2: ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ç”Ÿæˆ
embedding = await processor.step2_generate_embedding("è³ªå•å†…å®¹")

# Step 3: é¡ä¼¼æ¤œç´¢
chunks = await processor.step3_similarity_search(embedding, top_k=5)

# Step 4: å›ç­”ç”Ÿæˆ
answer = await processor.step4_generate_answer("è³ªå•å†…å®¹", chunks)

# Step 5: å›ç­”è¡¨ç¤º
result = await processor.step5_display_answer(answer)
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

### 1. åŸºæœ¬ãƒ†ã‚¹ãƒˆ
```bash
cd workmate/Chatbot-backend-main
python test_realtime_rag.py
```

### 2. å€‹åˆ¥ã‚¹ãƒ†ãƒƒãƒ—ãƒ†ã‚¹ãƒˆ
```python
# test_realtime_rag.pyå†…ã®test_step_by_step()é–¢æ•°ã‚’å®Ÿè¡Œ
```

### 3. ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
```python
from modules.chat_realtime_rag import get_realtime_rag_status

status = get_realtime_rag_status()
print(status)
```

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§

### å‡¦ç†æ™‚é–“ï¼ˆç›®å®‰ï¼‰
- Step 1 (è³ªå•å…¥åŠ›): < 1ms
- Step 2 (ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ç”Ÿæˆ): 200-500ms
- Step 3 (é¡ä¼¼æ¤œç´¢): 50-200ms
- Step 4 (LLMå›ç­”ç”Ÿæˆ): 1-3ç§’
- Step 5 (å›ç­”è¡¨ç¤º): < 1ms

**ç·å‡¦ç†æ™‚é–“**: ç´„1.5-4ç§’

### ç²¾åº¦å‘ä¸Šã®ãƒã‚¤ãƒ³ãƒˆ
1. **3072æ¬¡å…ƒã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°**: é«˜ç²¾åº¦ãªæ„å‘³ç†è§£
2. **åŸæ–‡ãƒ™ãƒ¼ã‚¹å›ç­”**: è¦ç´„ã«ã‚ˆã‚‹æƒ…å ±æå¤±ã‚’é˜²æ­¢
3. **Top-Kæ¤œç´¢**: é–¢é€£æ€§ã®é«˜ã„ãƒãƒ£ãƒ³ã‚¯ã®ã¿ã‚’ä½¿ç”¨
4. **pgvectoræœ€é©åŒ–**: é«˜é€Ÿãªãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢

## ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½

ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ RAGãŒåˆ©ç”¨ã§ããªã„å ´åˆã€è‡ªå‹•çš„ã«å¾“æ¥ã®RAGã‚·ã‚¹ãƒ†ãƒ ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™ï¼š

1. **ä¸¦åˆ—ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢**
2. **å˜ä¸€ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢**
3. **å¾“æ¥ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢**

## âš ï¸ æ³¨æ„äº‹é …

### åˆ¶é™äº‹é …
1. **APIåˆ¶é™**: Gemini APIã®åˆ©ç”¨åˆ¶é™ã«æ³¨æ„
2. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š**: Supabaseã®æ¥ç¶šåˆ¶é™
3. **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**: å¤§é‡ã®ãƒãƒ£ãƒ³ã‚¯ã‚’å‡¦ç†ã™ã‚‹éš›ã®æ³¨æ„

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- å„ã‚¹ãƒ†ãƒƒãƒ—ã§é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å®Ÿè£…
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã«ã‚ˆã‚Šå¯ç”¨æ€§ã‚’ç¢ºä¿
- è©³ç´°ãªãƒ­ã‚°å‡ºåŠ›ã§ãƒ‡ãƒãƒƒã‚°ã‚’æ”¯æ´

## ğŸ”§ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´
```python
# Top-Kå€¤ã®èª¿æ•´
top_k = 15  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 10

# é¡ä¼¼åº¦é–¾å€¤ã®èª¿æ•´
similarity_threshold = 0.7  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ãªã—

# æœ€å¤§ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé•·
max_context_length = 100000  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 100,000æ–‡å­—
```

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
```python
# Step 4ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
custom_prompt = f"""ã‚ãªãŸã¯{company_name}ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ã€ã‚«ã‚¹ã‚¿ãƒ æŒ‡ç¤ºã€‘
1. ã‚ˆã‚Šè©³ç´°ãªå›ç­”ã‚’æä¾›ã—ã¦ãã ã•ã„
2. é–¢é€£ã™ã‚‹è¿½åŠ æƒ…å ±ã‚‚å«ã‚ã¦ãã ã•ã„
...
"""
```

## ğŸ“ˆ ä»Šå¾Œã®æ‹¡å¼µäºˆå®š

1. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½**: é »ç¹ãªè³ªå•ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
2. **A/Bãƒ†ã‚¹ãƒˆ**: è¤‡æ•°ã®RAGæ‰‹æ³•ã®æ¯”è¼ƒ
3. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å­¦ç¿’**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«ã‚ˆã‚‹æ”¹å–„
4. **å¤šè¨€èªå¯¾å¿œ**: è‹±èªç­‰ã®ä»–è¨€èªã‚µãƒãƒ¼ãƒˆ

## ğŸ†˜ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

1. **ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ç”Ÿæˆå¤±æ•—**
   - API ã‚­ãƒ¼ã®ç¢ºèª
   - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã®ç¢ºèª

2. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼**
   - Supabaseè¨­å®šã®ç¢ºèª
   - pgvectoræ‹¡å¼µã®æœ‰åŠ¹åŒ–ç¢ºèª

3. **ãƒãƒ£ãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãªã„**
   - chunksãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ç¢ºèª
   - company_idãƒ•ã‚£ãƒ«ã‚¿ã®ç¢ºèª

### ãƒ‡ãƒãƒƒã‚°æ–¹æ³•
```python
# ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’ä¸Šã’ã‚‹
import logging
logging.basicConfig(level=logging.DEBUG)

# è©³ç´°ãªãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
from modules.realtime_rag import get_realtime_rag_processor
processor = get_realtime_rag_processor()
# å„ã‚¹ãƒ†ãƒƒãƒ—ã®è©³ç´°ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹
```

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’å«ã‚ã¦ãŠå•ã„åˆã‚ã›ãã ã•ã„ï¼š

1. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
2. å®Ÿè¡Œç’°å¢ƒï¼ˆPythonç‰ˆã€OSç­‰ï¼‰
3. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæ©Ÿå¯†æƒ…å ±ã¯é™¤ãï¼‰
4. å†ç¾æ‰‹é †

---

**å®Ÿè£…å®Œäº†æ—¥**: 2025å¹´6æœˆ26æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0  
**ä½œæˆè€…**: Roo (Claude Sonnet 4)