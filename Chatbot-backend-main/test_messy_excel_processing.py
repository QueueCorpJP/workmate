"""
ğŸ§ª ä¹±é›‘ãªExcelãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
å®Ÿéš›ã®ä¹±é›‘ãªãƒ‡ãƒ¼ã‚¿ã§ExcelDataCleanerã®å‹•ä½œã‚’ç¢ºèª
"""

import pandas as pd
import numpy as np
from io import BytesIO
import logging
from modules.excel_data_cleaner import ExcelDataCleaner

# ãƒ­ã‚®ãƒ³ã‚°è¨­å®š
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

def create_messy_excel_sample():
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæä¾›ã—ãŸã‚ˆã†ãªä¹±é›‘ãªExcelãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œæˆ
    """
    # ä¹±é›‘ãªãƒ‡ãƒ¼ã‚¿ã®ä¾‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¾‹ã‚’å‚è€ƒï¼‰
    messy_data = [
        [0, 6, "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", "", "", "", "â—‹", "ãƒ•ã‚©ãƒ¼ãƒãƒ«", "SS0101868", "900101868"],
        ["", "", "ï¼´ï¼¥ï¼® ï¼§ï½’ï½…ï½…ï½ ï¼¦ï½ï½ƒï½”ï½ï½’ï½™ æ ªå¼ä¼šç¤¾", "438-0803", "", "é™å²¡çœŒ", "", "", "", ""],
        ["é™å²¡çœŒç£ç”°å¸‚å¯Œä¸˜905-1 ã‚µãƒ³ã‚­ãƒ§ã‚¦ãƒã‚¤ãƒ„201å·", "", "", "", "éˆ´æœ¨è²´åš", "", "", "", "ãƒ“ã‚¸ã‚µãƒéƒ¨", ""],
        ["æ¢…æ²¢ä½‘çœŸ", "2022-04-19 00:00:00", "", "", "-", "NaT", "", "ISPH00365", "æœæ—¥ãƒãƒƒãƒˆ", ""],
        ["", "", "", "", "", "", "å›ºå®šãªã—", "ãƒ•ã‚¡ãƒŸãƒªãƒ¼", "SHSã‚¿ã‚¤ãƒ—éš¼", "800"],
        ["", "", "", "", "", "", "", "", "", "ã‚ã‚Š"],
        ["21109680", "", "", "CAF5325209664", "", "", "", "", "", ""],
        ["2022-05-09 00:00:00", "è¥¿é‡", "00:00:00", "", "", "", "", "", "", ""],
        ["-", "", "", "", "", "", "", "", "", ""],
        ["-", "", "", "", "", "", "", "", "", ""],
        ["ã‚­ãƒ£ãƒ³ã‚»ãƒ«", "", "", "", "", "ä¸è¦", "", "", "", ""],
        ["", "", "", "", "", "", "", "", "", ""],
        ["1", "ã¨ã‹", "", "", "", "", "", "", "", ""],
        ["", "", "", "", "", "", "", "", "", ""],
        ["NaT", "", "", "", "", "", "", "", "", ""],
        ["", "", "", "", "", "", "", "", "", ""],
        ["NaT", "", "", "", "", "", "", "", "", ""],
        ["ã¨ã‹ã‚ã£ã¦ã“ã†ã„ã†ã®ã£ã¦è³ªå•ã—ã¦ã‚‚å›ç­”ã§ããªã‹ã£ãŸã‚Šã™ã‚‹ã‚“ã ã‘ã©ã©ã†ã—ãŸã‚‰ã„ã„", "", "", "", "", "", "", "", "", ""]
    ]
    
    # DataFrameã‚’ä½œæˆ
    df = pd.DataFrame(messy_data)
    
    # Excelãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ï¼ˆãƒ¡ãƒ¢ãƒªä¸Šï¼‰
    buffer = BytesIO()
    with pd.ExcelWriter(buffer, engine='openpyxl') as writer:
        df.to_excel(writer, sheet_name='ä¹±é›‘ãªãƒ‡ãƒ¼ã‚¿', index=False, header=False)
    
    buffer.seek(0)
    return buffer.getvalue()

def create_structured_excel_sample():
    """
    æ¯”è¼ƒç”¨ã®æ§‹é€ åŒ–ã•ã‚ŒãŸExcelãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
    """
    structured_data = {
        'ä¼šç¤¾å': ['ï¼´ï¼¥ï¼® ï¼§ï½’ï½…ï½…ï½ ï¼¦ï½ï½ƒï½”ï½ï½’ï½™ æ ªå¼ä¼šç¤¾', 'ã‚µãƒ³ãƒ—ãƒ«ä¼šç¤¾A', 'ãƒ†ã‚¹ãƒˆä¼æ¥­B'],
        'éƒµä¾¿ç•ªå·': ['438-0803', '100-0001', '530-0001'],
        'ä½æ‰€': ['é™å²¡çœŒç£ç”°å¸‚å¯Œä¸˜905-1', 'æ±äº¬éƒ½åƒä»£ç”°åŒºåƒä»£ç”°1-1', 'å¤§é˜ªåºœå¤§é˜ªå¸‚åŒ—åŒºæ¢…ç”°1-1'],
        'æ‹…å½“è€…': ['éˆ´æœ¨è²´åš', 'ç”°ä¸­å¤ªéƒ', 'ä½è—¤èŠ±å­'],
        'éƒ¨ç½²': ['ãƒ“ã‚¸ã‚µãƒéƒ¨', 'å–¶æ¥­éƒ¨', 'é–‹ç™ºéƒ¨'],
        'å¥‘ç´„æ—¥': ['2022-04-19', '2022-05-01', '2022-06-15'],
        'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹': ['ã‚­ãƒ£ãƒ³ã‚»ãƒ«', 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–', 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–']
    }
    
    df = pd.DataFrame(structured_data)
    
    buffer = BytesIO()
    with pd.ExcelWriter(buffer, engine='openpyxl') as writer:
        df.to_excel(writer, sheet_name='æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿', index=False)
    
    buffer.seek(0)
    return buffer.getvalue()

async def test_messy_excel_processing():
    """
    ä¹±é›‘ãªExcelãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã‚’ãƒ†ã‚¹ãƒˆ
    """
    print("ğŸ§ª ä¹±é›‘ãªExcelãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ†ã‚¹ãƒˆé–‹å§‹")
    print("=" * 60)
    
    # ExcelDataCleanerã‚’åˆæœŸåŒ–
    cleaner = ExcelDataCleaner()
    
    # ãƒ†ã‚¹ãƒˆ1: ä¹±é›‘ãªãƒ‡ãƒ¼ã‚¿
    print("\nğŸ“Š ãƒ†ã‚¹ãƒˆ1: ä¹±é›‘ãªãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†")
    print("-" * 40)
    
    messy_excel_data = create_messy_excel_sample()
    
    try:
        cleaned_text = cleaner.clean_excel_data(messy_excel_data)
        print("âœ… ä¹±é›‘ãªãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†æˆåŠŸ")
        print(f"ğŸ“„ å‡¦ç†çµæœï¼ˆæœ€åˆã®500æ–‡å­—ï¼‰:")
        print(cleaned_text[:500])
        print("..." if len(cleaned_text) > 500 else "")
        print(f"\nğŸ“Š ç·æ–‡å­—æ•°: {len(cleaned_text)}")
        
    except Exception as e:
        print(f"âŒ ä¹±é›‘ãªãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†å¤±æ•—: {e}")
    
    # ãƒ†ã‚¹ãƒˆ2: æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
    print("\nğŸ“Š ãƒ†ã‚¹ãƒˆ2: æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†")
    print("-" * 40)
    
    structured_excel_data = create_structured_excel_sample()
    
    try:
        cleaned_text = cleaner.clean_excel_data(structured_excel_data)
        print("âœ… æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†æˆåŠŸ")
        print(f"ğŸ“„ å‡¦ç†çµæœ:")
        print(cleaned_text)
        print(f"\nğŸ“Š ç·æ–‡å­—æ•°: {len(cleaned_text)}")
        
    except Exception as e:
        print(f"âŒ æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†å¤±æ•—: {e}")

def test_data_analysis():
    """
    ãƒ‡ãƒ¼ã‚¿åˆ†ææ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
    """
    print("\nğŸ” ãƒ‡ãƒ¼ã‚¿åˆ†ææ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ")
    print("-" * 40)
    
    cleaner = ExcelDataCleaner()
    
    # ã‚µãƒ³ãƒ—ãƒ«DataFrame
    test_data = pd.DataFrame({
        'A': ['ä¼šç¤¾å', 'ï¼´ï¼¥ï¼® ï¼§ï½’ï½…ï½…ï½', 'ã‚µãƒ³ãƒ—ãƒ«ä¼šç¤¾', ''],
        'B': ['æ‹…å½“è€…', 'éˆ´æœ¨è²´åš', 'ç”°ä¸­å¤ªéƒ', ''],
        'C': ['é‡‘é¡', '1000', '2000', ''],
        'D': ['æ—¥ä»˜', '2022-04-19', '2022-05-01', '']
    })
    
    # æ§‹é€ åˆ†æ
    structure = cleaner._analyze_data_structure(test_data)
    print(f"ğŸ“Š æ§‹é€ åˆ†æçµæœ:")
    print(f"  - ãƒ˜ãƒƒãƒ€ãƒ¼æ¤œå‡º: {structure['has_headers']}")
    print(f"  - ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ: {structure['header_row']}")
    print(f"  - ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—: {structure['data_types']}")
    
    # ãƒ˜ãƒƒãƒ€ãƒ¼æ¤œå‡ºãƒ†ã‚¹ãƒˆ
    header_row = test_data.iloc[0]
    is_header = cleaner._looks_like_header(header_row)
    print(f"  - æœ€åˆã®è¡ŒãŒãƒ˜ãƒƒãƒ€ãƒ¼: {is_header}")

if __name__ == "__main__":
    print("ğŸš€ ä¹±é›‘ãªExcelãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆ")
    print("=" * 60)
    
    # éåŒæœŸãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    import asyncio
    asyncio.run(test_messy_excel_processing())
    
    # ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ†ã‚¹ãƒˆ
    test_data_analysis()
    
    print("\nğŸ‰ ãƒ†ã‚¹ãƒˆå®Œäº†")
    print("\nğŸ’¡ ä½¿ç”¨æ–¹æ³•:")
    print("1. ä¹±é›‘ãªExcelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰")
    print("2. ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ãƒ»æ§‹é€ åŒ–")
    print("3. æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦è³ªå•å¿œç­”ãŒå¯èƒ½")
    print("\nğŸ“ æ”¹å–„ç‚¹:")
    print("- ã‚ˆã‚Šè¤‡é›‘ãªãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å¯¾å¿œ")
    print("- æ¥­ç•Œå›ºæœ‰ã®ç”¨èªè¾æ›¸ã®è¿½åŠ ")
    print("- ãƒ‡ãƒ¼ã‚¿å“è³ªã‚¹ã‚³ã‚¢ã®è¡¨ç¤º")